FROM node:20-alpine

# ビルドに必要なネイティブツール（bcrypt 等のコンパイルに使用）
RUN apk add --no-cache python3 make g++ openssl

WORKDIR /app

# 依存関係のインストール（ソースコードより先にコピーしてキャッシュ効率化）
COPY package.json pnpm-lock.yaml* ./
RUN npm install -g pnpm && pnpm install

# ソースコードをコピー
COPY . .

EXPOSE 8000

# 起動時に prisma generate を実行してから dev サーバを起動
# ビルド時ではなく起動時に実行 → DATABASE_URL が利用可能なため
CMD ["sh", "-c", "pnpm prisma generate && pnpm dev"]
