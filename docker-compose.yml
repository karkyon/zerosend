# =====================================
# ファイルパス  : zerosend/docker-compose.yml
#
# 説明・目的・機能概要:
#   モノレポルートの Docker Compose 定義。
#   zerosend-api (backend/) + PostgreSQL 16 + Redis 7 + MailHog を
#   一括管理する。フロントエンドは別途 frontend/ 配下で管理予定。
#
#   サービス構成:
#     api       — backend/ の Hono API サーバ (port: 8000)
#     db        — PostgreSQL 16 (port: 5432)
#     redis     — Redis 7 (port: 6379)
#     mailhog   — 開発用メールキャッチャー (SMTP: 1025 / UI: 8025)
#
# 作成日時 : 2026-02-21
# 更新日時 : 2026-02-21
#
# 使い方:
#   docker compose up -d          # 全サービス起動
#   docker compose logs -f api    # APIログ確認
#   docker compose down           # 停止
# =====================================

services:

  # ─── Backend API ────────────────────────────────────────────────────────────
  api:
    build:
      context: ./backend          # ← モノレポ: backend/ ディレクトリを参照
      dockerfile: Dockerfile.dev
    container_name: zerosend-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./backend/src:/app/src                    # ソース: ホットリロード対象
      - ./backend/prisma:/app/prisma              # Prisma スキーマ
      - ./backend/prisma.config.ts:/app/prisma.config.ts
      - /app/node_modules                         # node_modules はコンテナ内を優先
    environment:
      NODE_ENV:             development
      PORT:                 8000
      DATABASE_URL:         postgresql://zerosend:zerosend_dev_pass@db:5432/zerosend_db
      REDIS_URL:            redis://redis:6379
      JWT_SECRET:           ${JWT_SECRET:-change_me_in_production_32chars_min}
      JWT_EXPIRES_IN:       ${JWT_EXPIRES_IN:-8h}
      TOTP_ENCRYPTION_KEY:  ${TOTP_ENCRYPTION_KEY:-change_me_32byte_hex_key_000000000}
      SMTP_HOST:            mailhog
      SMTP_PORT:            1025
      SMTP_SECURE:          "false"
      SMTP_USER:            ""
      SMTP_PASS:            ""
      MAIL_FROM:            noreply@zerosend.local
      FRONTEND_BASE_URL:    http://localhost:3000
      APP_BASE_URL:         http://localhost:8000
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - zerosend-net

  # ─── PostgreSQL 16 ─────────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    container_name: zerosend-db
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB:       zerosend_db
      POSTGRES_USER:     zerosend
      POSTGRES_PASSWORD: zerosend_dev_pass
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres/init:/docker-entrypoint-initdb.d:ro  # 初期DDL
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U zerosend -d zerosend_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - zerosend-net

  # ─── Redis 7 ───────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: zerosend-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - zerosend-net

  # ─── MailHog (開発用メールキャッチャー) ─────────────────────────────────────
  mailhog:
    image: mailhog/mailhog:latest
    container_name: zerosend-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI → http://localhost:8025
    networks:
      - zerosend-net

volumes:
  postgres-data:
    name: zerosend_postgres-data
  redis-data:
    name: zerosend_redis-data

networks:
  zerosend-net:
    name: zerosend-net
    driver: bridge
