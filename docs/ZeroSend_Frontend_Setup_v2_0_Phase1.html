<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZeroSend ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹ç¯‰æ‰‹é †æ›¸ v2.0 â€” Phase 1 èªè¨¼ãƒ»éµç®¡ç†</title>
<style>
:root{
  --navy:#0F2744;--blue:#2563EB;--blue-l:#EFF6FF;
  --green:#15803D;--green-l:#ECFDF5;
  --amber:#B45309;--amber-l:#FFFBEB;
  --red:#B91C1C;--red-l:#FEF2F2;
  --purple:#7C3AED;--purple-l:#F5F3FF;
  --teal:#0D9488;--teal-l:#F0FDFA;
  --gray:#6B7280;--light:#F8FAFC;
  --border:#E2E8F0;--code:#1E293B;--codefg:#E2E8F0;
  --done:#065F46;--done-l:#ECFDF5;
  --indigo:#4338CA;--indigo-l:#EEF2FF;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',Arial,sans-serif;font-size:14px;color:#1E293B;background:#F1F5F9;line-height:1.65}
.wrap{max-width:1060px;margin:0 auto;padding:32px 24px}
.cover{background:linear-gradient(135deg,#0F2744 0%,#1E3A5F 60%,#312e81 100%);color:#fff;padding:52px 44px;border-radius:16px;margin-bottom:36px;box-shadow:0 12px 40px rgba(0,0,0,.25)}
.cover h1{font-size:34px;font-weight:900;letter-spacing:-.5px;line-height:1.25}
.cover .en{font-size:13px;color:#a5b4fc;margin-top:5px}
.vbadge{display:inline-block;background:var(--teal);padding:5px 16px;border-radius:20px;font-size:13px;font-weight:700;margin-top:14px}
.part-badge{display:inline-block;background:#7C3AED;padding:5px 16px;border-radius:20px;font-size:13px;font-weight:700;margin-top:8px;margin-left:8px}
.cg{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:24px}
.ci{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 14px}
.ci .l{font-size:10px;color:#a5b4fc;text-transform:uppercase;letter-spacing:.06em}
.ci .v{font-family:'Courier New',monospace;font-size:11.5px;color:#fff;margin-top:3px}
.nav{background:#fff;border:1px solid var(--border);border-radius:10px;padding:16px 20px;margin-bottom:24px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.nav .nt{font-weight:700;color:var(--navy);font-size:13px;margin-bottom:8px}
.nav-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px}
.nav-item{font-size:12px;color:#374151;padding:4px 8px;background:#F8FAFC;border-radius:6px;border:1px solid var(--border)}
.nav-item a{color:var(--blue);text-decoration:none;font-weight:600}
h1.s{font-size:22px;font-weight:800;color:var(--navy);border-bottom:3px solid var(--blue);padding-bottom:8px;margin:40px 0 18px}
h2.s{font-size:16px;font-weight:700;color:var(--navy);border-left:5px solid var(--blue);padding-left:10px;margin:24px 0 10px}
p{font-size:13px;color:#374151;margin:5px 0 8px;line-height:1.7}
ul,ol{padding-left:20px;font-size:13px;color:#374151;margin:6px 0}
li{margin:3px 0}
.step{display:flex;border-radius:10px;overflow:hidden;border:1px solid var(--border);margin:20px 0 14px;box-shadow:0 1px 4px rgba(0,0,0,.07)}
.sn{padding:14px 16px;font-weight:800;display:flex;flex-direction:column;align-items:center;justify-content:center;min-width:76px}
.sn .sl{font-size:9px;text-transform:uppercase;letter-spacing:.1em;opacity:.75}
.sn .sv{font-size:26px;line-height:1}
.sb{padding:12px 18px;flex:1}
.sb .st{font-size:15px;font-weight:700}
.sb .ss{font-size:12px;color:var(--gray);margin-top:3px}
.step.todo .sn{background:var(--purple);color:#fff}.step.todo .sb{background:var(--purple-l)}.step.todo .st{color:var(--purple)}
.step.done .sn{background:var(--done);color:#fff}.step.done .sb{background:var(--done-l)}.step.done .st{color:var(--done)}
.step.info .sn{background:var(--indigo);color:#fff}.step.info .sb{background:var(--indigo-l)}.step.info .st{color:var(--indigo)}
.step.sec-step .sn{background:#9333ea;color:#fff}.step.sec-step .sb{background:#fdf4ff}.step.sec-step .st{color:#7C3AED}
.box{border-radius:8px;padding:12px 16px;margin:10px 0;border-left:5px solid;font-size:13px}
.box .bt{font-weight:700;font-size:11px;margin-bottom:6px;text-transform:uppercase;letter-spacing:.05em}
.box p,.box li{margin:3px 0;line-height:1.6}
.box ul{padding-left:18px}
.tip{background:var(--blue-l);border-color:var(--blue)}.tip .bt{color:var(--blue)}
.ok{background:var(--done-l);border-color:var(--done)}.ok .bt{color:var(--done)}
.warn{background:var(--amber-l);border-color:var(--amber)}.warn .bt{color:var(--amber)}
.err{background:var(--red-l);border-color:var(--red)}.err .bt{color:var(--red)}
.sec{background:#FDF4FF;border-color:#A855F7}.sec .bt{color:#7C3AED}
.new-b{background:var(--teal-l);border-color:var(--teal)}.new-b .bt{color:var(--teal)}
.clbl{font-size:11px;color:#94A3B8;font-family:'Courier New',monospace;background:#0F172A;border:1px solid #334155;border-bottom:none;padding:5px 14px;border-radius:8px 8px 0 0;display:inline-block;margin-top:8px}
pre{background:var(--code);border:1px solid #334155;border-radius:0 8px 8px 8px;padding:16px 18px;font-family:'Courier New',monospace;font-size:12px;color:var(--codefg);line-height:1.75;overflow-x:auto;margin:0 0 14px;white-space:pre}
.result{background:#0a1628;border:1px solid #1e3a5f;border-radius:8px;padding:14px 18px;font-family:'Courier New',monospace;font-size:12px;color:#93C5FD;line-height:1.8;margin:0 0 14px;white-space:pre}
.result .ok-r{color:#4ADE80}
.result .err-r{color:#F87171}
.result .warn-r{color:#FCD34D}
table{width:100%;border-collapse:collapse;font-size:13px;margin:12px 0;border-radius:8px;overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.08)}
th{background:var(--navy);color:#fff;padding:9px 13px;text-align:left;font-size:12px;font-weight:600}
td{padding:8px 13px;border-bottom:1px solid var(--border);vertical-align:top}
tr:nth-child(even) td{background:var(--light)}
td code{font-family:'Courier New',monospace;font-size:11.5px;background:#EFF6FF;color:var(--navy);padding:1px 5px;border-radius:3px}
.dc{color:var(--done);font-weight:700}
.rc{color:var(--red);font-weight:700}
.tree{background:var(--code);border:1px solid #334155;border-radius:10px;padding:18px 22px;font-family:'Courier New',monospace;font-size:12.5px;color:var(--codefg);line-height:2;margin:12px 0;overflow-x:auto}
.tree .d{color:#93C5FD;font-weight:700}
.tree .fn{color:#E2E8F0}
.tree .cm{color:#64748B}
.tree .new-f{color:#4ADE80;font-weight:700}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;margin:0 2px}
.b-new{background:#DCFCE7;color:#15803D}
.b-edit{background:#DBEAFE;color:#1D4ED8}
.file-card{background:#fff;border:1px solid var(--border);border-radius:10px;margin:14px 0;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.07)}
.file-card .fc-head{background:#0F172A;padding:10px 18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.file-card .fc-path{font-family:'Courier New',monospace;font-size:12.5px;color:#93C5FD;font-weight:700}
.file-card .fc-badge{font-size:10px;padding:2px 8px;border-radius:10px}
.file-card .fc-badge.new{background:#064E3B;color:#6EE7B7}
.file-card .fc-badge.upd{background:#1E3A5F;color:#93C5FD}
.file-card .fc-badge.sec{background:#4C1D95;color:#C4B5FD}
.file-card .fc-body{padding:14px 18px;font-size:13px;color:#374151}
.file-card .fc-desc{margin-bottom:4px;line-height:1.7}
hr.pb{border:none;border-top:2px dashed var(--border);margin:44px 0}
.tag-f{display:inline-block;background:var(--indigo-l);color:var(--indigo);font-size:10px;font-weight:700;padding:1px 7px;border-radius:10px;margin-left:6px;border:1px solid #C7D2FE}
.security-critical{background:linear-gradient(135deg,#1a0533,#2d1454);border:2px solid #9333ea;border-radius:12px;padding:20px 24px;margin:16px 0}
.security-critical .sc-title{color:#e879f9;font-weight:800;font-size:14px;margin-bottom:12px}
.security-critical ul{color:#d8b4fe;font-size:13px;padding-left:20px}
.security-critical li{margin:6px 0;line-height:1.6}
.security-critical strong{color:#f0abfc}
</style>
</head>
<body><div class="wrap">

<!-- COVER -->
<div class="cover">
  <div>
    <span class="vbadge">v2.0</span>
    <span class="part-badge">Phase 1 â€” èªè¨¼ãƒ»éµç®¡ç† F-11ã€œF-15</span>
  </div>
  <h1 style="margin-top:16px">ZeroSend<br>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ§‹ç¯‰æ‰‹é †æ›¸</h1>
  <p class="en">Next-Generation Zero-Retention Quantum-Resistant File Transfer â€” Phase 1 Auth &amp; Key Management</p>
  <div class="cg">
    <div class="ci"><div class="l">å‰æ</div><div class="v">Phase 0 å®Œäº†æ¸ˆã¿</div></div>
    <div class="ci"><div class="l">æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«</div><div class="v">5ãƒ•ã‚¡ã‚¤ãƒ«</div></div>
    <div class="ci"><div class="l">æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«</div><div class="v">3ãƒ•ã‚¡ã‚¤ãƒ«</div></div>
    <div class="ci"><div class="l">è¿½åŠ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸</div><div class="v">ãªã—ï¼ˆç¢ºèªã®ã¿ï¼‰</div></div>
    <div class="ci"><div class="l">æš—å·ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</div><div class="v">ml_kem768.keygen()</div></div>
    <div class="ci"><div class="l">ç§˜å¯†éµä¿å­˜å…ˆ</div><div class="v">IndexedDB ã®ã¿</div></div>
    <div class="ci"><div class="l">JWT ä¿å­˜å…ˆ</div><div class="v">Zustand ãƒ¡ãƒ¢ãƒªã®ã¿</div></div>
    <div class="ci"><div class="l">ç›£æŸ»ãƒ­ã‚°</div><div class="v">securityLogger.ts</div></div>
  </div>
</div>

<!-- ç›®æ¬¡ -->
<div class="nav">
  <div class="nt">ğŸ“‹ ã“ã®æ‰‹é †æ›¸ã®å¯¾è±¡ã‚¿ã‚¹ã‚¯ï¼ˆF-11ã€œF-15ï¼‰</div>
  <div class="nav-grid">
    <div class="nav-item"><a href="#step1">STEP 1</a> ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª</div>
    <div class="nav-item"><a href="#step2">STEP 2</a> ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ</div>
    <div class="nav-item"><a href="#step3">STEP 3</a> securityLogger.ts <span class="badge b-new">NEW</span></div>
    <div class="nav-item"><a href="#step4">STEP 4</a> authService.ts <span class="badge b-new">NEW</span></div>
    <div class="nav-item"><a href="#step5">STEP 5</a> authStore.ts <span class="badge b-edit">UPDATE</span></div>
    <div class="nav-item"><a href="#step6">STEP 6</a> LoginPage.tsx <span class="badge b-edit">UPDATE</span></div>
    <div class="nav-item"><a href="#step7">STEP 7</a> RegisterPage.tsx <span class="badge b-new">NEW</span></div>
    <div class="nav-item"><a href="#step8">STEP 8</a> TotpModal.tsx <span class="badge b-new">NEW</span></div>
    <div class="nav-item"><a href="#step9">STEP 9</a> ProtectedRoute.tsx <span class="badge b-edit">UPDATE</span></div>
    <div class="nav-item"><a href="#step10">STEP 10</a> App.tsx <span class="badge b-edit">UPDATE</span></div>
    <div class="nav-item"><a href="#step11">STEP 11</a> å‹•ä½œç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆ</div>
    <div class="nav-item"><a href="#trouble">STEP 12</a> ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</div>
  </div>
</div>

<div class="box warn">
  <div class="bt">âš ï¸ å‰ææ¡ä»¶</div>
  <p>Phase 0ï¼ˆF-01ã€œF-10ï¼‰å®Œäº†æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã€‚ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒ <code>docker compose up -d</code> ã§èµ·å‹•ä¸­ã§ã‚ã‚‹ã“ã¨ã€‚</p>
</div>

<div class="security-critical">
  <div class="sc-title">ğŸ” Phase 1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®3å¤§åŸå‰‡ï¼ˆä½œæ¥­å‰ã«å¿…èª­ï¼‰</div>
  <ul>
    <li><strong>ç§˜å¯†éµ (ML-KEM-768 secretKey)</strong> ã¯ IndexedDB ã«ã®ã¿ä¿å­˜ã€‚çµ¶å¯¾ã«ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ã—ãªã„</li>
    <li><strong>JWT (access_token)</strong> ã¯ Zustand ãƒ¡ãƒ¢ãƒªã«ã®ã¿ä¿æŒã€‚localStorage / sessionStorage ã«ã¯çµ¶å¯¾ã«ä¿å­˜ã—ãªã„ï¼ˆXSSå¯¾ç­–ï¼‰</li>
    <li><strong>å…¨èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆ</strong>ã¯ securityLogger.ts ã§è¨˜éŒ²ã™ã‚‹</li>
  </ul>
</div>

<hr class="pb">

<!-- STEP 1 -->
<h1 class="s" id="step1">STEP 1 â€” ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç¢ºèª</h1>
<div class="step todo">
  <div class="sn"><div class="sl">STEP</div><div class="sv">1</div></div>
  <div class="sb">
    <div class="st">@noble/post-quantum ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª</div>
    <div class="ss">Phase 0 ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®ã¯ãšã€‚æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã®ã¿è¿½åŠ ã™ã‚‹</div>
  </div>
</div>
<div class="clbl">frontend/ ã§å®Ÿè¡Œ</div>
<pre>cd ~/projects/zerosend/frontend
pnpm list @noble/post-quantum</pre>
<div class="result"><span class="ok-r">âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®å ´åˆ:</span>
dependencies:
@noble/post-quantum 0.x.x

<span class="warn-r">âœ— æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®å ´åˆã®ã¿å®Ÿè¡Œ:</span>
pnpm add @noble/post-quantum</div>
<div class="box ok"><div class="bt">âœ… STEP 1 å®Œäº†ç¢ºèª</div><p>@noble/post-quantum ãŒè¡¨ç¤ºã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 2 -->
<h1 class="s" id="step2">STEP 2 â€” æ–°è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ</h1>
<div class="step todo">
  <div class="sn"><div class="sl">STEP</div><div class="sv">2</div></div>
  <div class="sb">
    <div class="st">services/ ã¨ components/auth/ ã®2ã¤ã‚’æ–°è¦ä½œæˆã™ã‚‹</div>
    <div class="ss">frontend/src/ ç›´ä¸‹ã§å®Ÿè¡Œã™ã‚‹ã“ã¨</div>
  </div>
</div>
<div class="clbl">ã‚¿ãƒ¼ãƒŸãƒŠãƒ«</div>
<pre>mkdir -p src/services src/components/auth</pre>
<div class="clbl">ç¢ºèª</div>
<pre>find src -type d | sort</pre>
<div class="result">src/components/<span class="ok-r">auth</span>       â† æ–°è¦
src/<span class="ok-r">services</span>           â† æ–°è¦</div>
<div class="box ok"><div class="bt">âœ… STEP 2 å®Œäº†ç¢ºèª</div><p>ä¸Šè¨˜2ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¡¨ç¤ºã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 3: securityLogger -->
<h1 class="s" id="step3">STEP 3 â€” src/lib/securityLogger.ts æ–°è¦ä½œæˆ <span class="tag-f">å…¨ã‚¿ã‚¹ã‚¯å…±é€šåŸºç›¤</span></h1>
<div class="step sec-step">
  <div class="sn"><div class="sl">STEP</div><div class="sv">3</div></div>
  <div class="sb">
    <div class="st">ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚¬ãƒ¼ã‚’ä½œæˆã™ã‚‹ï¼ˆæœ€åˆã«ä½œã‚‹ã“ã¨ï¼‰</div>
    <div class="ss">ä»–ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã€‚å¿…ãšå…ˆã«ä½œæˆã™ã‚‹ã“ã¨</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/lib/securityLogger.ts</span>
    <span class="fc-badge new">ğŸ†• æ–°è¦ä½œæˆ</span>
  </div>
  <div class="fc-body"><p class="fc-desc">å…¨èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆãƒ»æš—å·éµæ“ä½œã‚’è¨˜éŒ²ã™ã‚‹ãƒ­ã‚¬ãƒ¼ã€‚å¤–éƒ¨ä¾å­˜ãªã—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº– API ã®ã¿ï¼‰ã€‚<br>æ©Ÿå¯†æƒ…å ±ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ç§˜å¯†éµï¼‰ã¯çµ¶å¯¾ã«ãƒ­ã‚°å‡ºåŠ›ã—ãªã„ã€‚</p></div>
</div>
<div class="clbl">frontend/src/lib/securityLogger.ts â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹</div>
<pre>// =============================================================
// ZeroSend â€” lib/securityLogger.ts
//
// ãƒ‘ã‚¹        : frontend/src/lib/securityLogger.ts
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : èªè¨¼ãƒ»æš—å·éµæ“ä½œã«é–¢ã™ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã®ä¸€å…ƒãƒ­ã‚¬ãƒ¼
//               é–‹ç™ºç’°å¢ƒ: ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä»˜ãã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ› (è‰²åˆ†ã‘ãƒ»groupCollapsed)
//               æœ¬ç•ªç’°å¢ƒ: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç›£æŸ»ãƒ­ã‚°é€ä¿¡ã¸æ‹¡å¼µå¯èƒ½ (ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆ)
//
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆåŸå‰‡:
//   - å…¨èªè¨¼ã‚¤ãƒ™ãƒ³ãƒˆã« ISO 8601 ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä»˜ä¸
//   - æ©Ÿå¯†æƒ…å ±ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ç§˜å¯†éµï¼‰ã¯çµ¶å¯¾ã«ãƒ­ã‚°å‡ºåŠ›ã—ãªã„
//   - CRITICAL/ERROR ãƒ¬ãƒ™ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ console.error ã«æ˜‡æ ¼
//   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæƒ…å ±ã‚’è¨˜éŒ²ï¼ˆä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è¿½è·¡ç”¨ï¼‰
//
// ä¾å­˜é–¢ä¿‚    :
//   (å¤–éƒ¨ä¾å­˜ãªã— â€” ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº– API ã®ã¿ä½¿ç”¨)
//
// ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥:
//   èªè¨¼ãƒ•ãƒ­ãƒ¼  : LOGIN_ATTEMPT / LOGIN_SUCCESS / LOGIN_FAILURE / LOGOUT / LOGOUT_FORCED
//   ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²: REGISTER_ATTEMPT / REGISTER_SUCCESS / REGISTER_FAILURE
//   TOTP 2FA   : TOTP_ATTEMPT / TOTP_SUCCESS / TOTP_FAILURE / TOTP_LOCKED
//   æš—å·éµæ“ä½œ  : KEY_PAIR_GENERATE_START / KEY_PAIR_GENERATE_SUCCESS
//                KEY_PAIR_STORE_SUCCESS / KEY_PAIR_STORE_FAILURE / KEY_PAIR_RETRIEVE
//   ãƒˆãƒ¼ã‚¯ãƒ³    : TOKEN_NEAR_EXPIRY / TOKEN_EXPIRED
//   ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡: UNAUTHORIZED_ACCESS / FORBIDDEN_ACCESS
//
// é‡å¤§åº¦ãƒ¬ãƒ™ãƒ«:
//   INFO     : æ­£å¸¸ãªã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸãƒ»éµç”Ÿæˆå®Œäº† ç­‰ï¼‰
//   WARN     : æ³¨æ„ãŒå¿…è¦ãªã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ãƒ»TOTPå¤±æ•—ãƒ»æœŸé™åˆ‡ã‚Œè­¦å‘Š ç­‰ï¼‰
//   ERROR    : ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ ç­‰ï¼‰
//   CRITICAL : å³æ™‚å¯¾å¿œãŒå¿…è¦ãªã‚¤ãƒ™ãƒ³ãƒˆï¼ˆTOTP URLãƒ­ãƒƒã‚¯ãƒ»éµä¿å­˜å¤±æ•— ç­‰ï¼‰
//
// ä½¿ç”¨ç®‡æ‰€    :
//   @/services/authService              ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²/TOTP å„å‡¦ç†
//   @/stores/authStore                  ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
//   @/components/layout/ProtectedRoute  ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
// =============================================================

// â”€â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥å®šç¾© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export type SecurityEventType =
  // èªè¨¼ãƒ•ãƒ­ãƒ¼
  | &#x27;LOGIN_ATTEMPT&#x27;
  | &#x27;LOGIN_SUCCESS&#x27;
  | &#x27;LOGIN_FAILURE&#x27;
  | &#x27;LOGOUT&#x27;
  | &#x27;LOGOUT_FORCED&#x27;           // 401 / ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œã«ã‚ˆã‚‹å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
  | &#x27;REGISTER_ATTEMPT&#x27;
  | &#x27;REGISTER_SUCCESS&#x27;
  | &#x27;REGISTER_FAILURE&#x27;
  // TOTP 2FA
  | &#x27;TOTP_ATTEMPT&#x27;
  | &#x27;TOTP_SUCCESS&#x27;
  | &#x27;TOTP_FAILURE&#x27;
  | &#x27;TOTP_LOCKED&#x27;             // 5å›å¤±æ•—ã«ã‚ˆã‚‹URLãƒ­ãƒƒã‚¯ (423)
  // æš—å·éµæ“ä½œï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦ï¼‰
  | &#x27;KEY_PAIR_GENERATE_START&#x27;
  | &#x27;KEY_PAIR_GENERATE_SUCCESS&#x27;
  | &#x27;KEY_PAIR_STORE_SUCCESS&#x27;  // IndexedDB ä¿å­˜æˆåŠŸ
  | &#x27;KEY_PAIR_STORE_FAILURE&#x27;
  | &#x27;KEY_PAIR_RETRIEVE&#x27;       // å¾©å·æ™‚ã«ç§˜å¯†éµå–å¾—
  // ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
  | &#x27;TOKEN_NEAR_EXPIRY&#x27;       // æœ‰åŠ¹æœŸé™ã¾ã§é–¾å€¤ä»¥å†…
  | &#x27;TOKEN_EXPIRED&#x27;           // æœŸé™åˆ‡ã‚Œæ¤œå‡º
  // ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
  | &#x27;UNAUTHORIZED_ACCESS&#x27;     // æœªèªè¨¼ã§ã®ãƒ«ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
  | &#x27;FORBIDDEN_ACCESS&#x27;        // admin æ¨©é™ä¸è¶³ã§ã®ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ

export type SecurityLevel = &#x27;INFO&#x27; | &#x27;WARN&#x27; | &#x27;ERROR&#x27; | &#x27;CRITICAL&#x27;

// â”€â”€â”€ ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface SecurityEventPayload {
  type: SecurityEventType
  level: SecurityLevel
  timestamp: string           // ISO 8601
  userId?: string             // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ID
  email?: string              // å¯¾è±¡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆãƒãƒƒã‚·ãƒ¥åŒ–æ¨å¥¨ã ãŒä»Šã¯å¹³æ–‡ï¼‰
  path?: string               // ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œãƒ‘ã‚¹
  detail?: Record&lt;string, unknown&gt;  // è¿½åŠ æƒ…å ±ï¼ˆæ©Ÿå¯†æƒ…å ±ã¯å«ã‚ãªã„ï¼‰
  userAgent: string
}

// â”€â”€â”€ é–‹ç™ºç’°å¢ƒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const CONSOLE_STYLES: Record&lt;SecurityLevel, string&gt; = {
  INFO:     &#x27;color: #6366f1; font-weight: 600&#x27;,
  WARN:     &#x27;color: #f59e0b; font-weight: 700&#x27;,
  ERROR:    &#x27;color: #ef4444; font-weight: 700&#x27;,
  CRITICAL: &#x27;color: #dc2626; font-weight: 700; text-decoration: underline; font-size: 13px&#x27;,
}

const LEVEL_BADGE: Record&lt;SecurityLevel, string&gt; = {
  INFO:     &#x27;ğŸ”µ INFO&#x27;,
  WARN:     &#x27;ğŸŸ¡ WARN&#x27;,
  ERROR:    &#x27;ğŸ”´ ERROR&#x27;,
  CRITICAL: &#x27;ğŸš¨ CRITICAL&#x27;,
}

// â”€â”€â”€ æœ¬ç•ªç’°å¢ƒãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€ä¿¡ï¼ˆæ‹¡å¼µç‚¹ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// å°†æ¥çš„ã«ã¯ GET /admin/logs ã¨é€£æºã™ã‚‹ç›£æŸ»ã‚¤ãƒ™ãƒ³ãƒˆã‚’é€ä¿¡ã™ã‚‹
// ç¾æ™‚ç‚¹ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã®ã¿ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã¯ backend ã® audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«ã§è¨˜éŒ²ï¼‰
//
// async function sendToAuditBackend(event: SecurityEventPayload): Promise&lt;void&gt; {
//   try {
//     await fetch(`${import.meta.env.VITE_API_BASE_URL}/audit/frontend`, {
//       method: &#x27;POST&#x27;,
//       headers: { &#x27;Content-Type&#x27;: &#x27;application/json&#x27; },
//       body: JSON.stringify(event),
//       keepalive: true,  // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã‚‚é€ä¿¡å®Œäº†ã•ã›ã‚‹
//     })
//   } catch {
//     // ç›£æŸ»ãƒ­ã‚°é€ä¿¡å¤±æ•—ã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã«ï¼ˆæœ¬æ¥ã®å‡¦ç†ã‚’æ­¢ã‚ãªã„ï¼‰
//   }
// }

// â”€â”€â”€ ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¬ãƒ¼é–¢æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²ã™ã‚‹
 *
 * @param type    - ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥
 * @param level   - é‡å¤§åº¦ãƒ¬ãƒ™ãƒ«
 * @param detail  - è¿½åŠ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ç§˜å¯†éµãªã©ã‚’å«ã‚ãªã„ã“ã¨ï¼‰
 * @param userId  - å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆèªè¨¼æ¸ˆã¿ã®å ´åˆï¼‰
 * @param email   - å¯¾è±¡ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰
 *
 * @example
 * logSecurityEvent(&#x27;LOGIN_ATTEMPT&#x27;, &#x27;INFO&#x27;, { email: &#x27;user@example.com&#x27; })
 * logSecurityEvent(&#x27;TOTP_FAILURE&#x27;, &#x27;WARN&#x27;, { remainingAttempts: 3 }, userId)
 * logSecurityEvent(&#x27;UNAUTHORIZED_ACCESS&#x27;, &#x27;ERROR&#x27;, { path: &#x27;/admin&#x27; })
 */
export function logSecurityEvent(
  type: SecurityEventType,
  level: SecurityLevel = &#x27;INFO&#x27;,
  detail?: Record&lt;string, unknown&gt;,
  userId?: string,
  email?: string,
): void {
  const event: SecurityEventPayload = {
    type,
    level,
    timestamp: new Date().toISOString(),
    userId,
    email,
    path: window.location.pathname,
    detail,
    userAgent: navigator.userAgent,
  }

  if (import.meta.env.DEV) {
    const style = CONSOLE_STYLES[level]
    const badge = LEVEL_BADGE[level]

    if (level === &#x27;CRITICAL&#x27; || level === &#x27;ERROR&#x27;) {
      console.error(
        `%c[ZeroSend Security] ${badge} â€” ${event.type}`,
        style,
        &#x27;\n&#x27;,
        { timestamp: event.timestamp, userId, email, path: event.path, detail },
      )
    } else {
      console.groupCollapsed(
        `%c[ZeroSend Security] ${badge} â€” ${event.type}`,
        style,
      )
      console.log(&#x27;â±  Timestamp:&#x27;, event.timestamp)
      console.log(&#x27;ğŸ“ Path:&#x27;, event.path)
      if (userId) console.log(&#x27;ğŸ‘¤ UserID:&#x27;, userId)
      if (email)  console.log(&#x27;ğŸ“§ Email:&#x27;, email)
      if (detail) console.log(&#x27;ğŸ“‹ Detail:&#x27;, detail)
      console.log(&#x27;ğŸ–¥  UserAgent:&#x27;, event.userAgent.substring(0, 80) + &#x27;...&#x27;)
      console.groupEnd()
    }
  }

  // æœ¬ç•ªç’°å¢ƒãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€ä¿¡ï¼ˆå¿…è¦æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆè§£é™¤ï¼‰
  // if (import.meta.env.PROD &amp;&amp; (level === &#x27;ERROR&#x27; || level === &#x27;CRITICAL&#x27; || level === &#x27;WARN&#x27;)) {
  //   sendToAuditBackend(event)
  // }
}

// â”€â”€â”€ ä¾¿åˆ©ãƒ©ãƒƒãƒ‘ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ */
export const logLoginAttempt = (email: string) =&gt;
  logSecurityEvent(&#x27;LOGIN_ATTEMPT&#x27;, &#x27;INFO&#x27;, undefined, undefined, email)

/** ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ */
export const logLoginSuccess = (userId: string, email: string) =&gt;
  logSecurityEvent(&#x27;LOGIN_SUCCESS&#x27;, &#x27;INFO&#x27;, undefined, userId, email)

/** ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•— */
export const logLoginFailure = (email: string, reason: string) =&gt;
  logSecurityEvent(&#x27;LOGIN_FAILURE&#x27;, &#x27;WARN&#x27;, { reason }, undefined, email)

/** ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆé€šå¸¸ï¼‰ */
export const logLogout = (userId: string) =&gt;
  logSecurityEvent(&#x27;LOGOUT&#x27;, &#x27;INFO&#x27;, undefined, userId)

/** ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆå¼·åˆ¶ï¼‰ */
export const logForcedLogout = (reason: &#x27;token_expired&#x27; | &#x27;unauthorized_401&#x27;) =&gt;
  logSecurityEvent(&#x27;LOGOUT_FORCED&#x27;, &#x27;WARN&#x27;, { reason })

/** ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²è©¦è¡Œ */
export const logRegisterAttempt = (email: string) =&gt;
  logSecurityEvent(&#x27;REGISTER_ATTEMPT&#x27;, &#x27;INFO&#x27;, undefined, undefined, email)

/** ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æˆåŠŸ */
export const logRegisterSuccess = (userId: string, email: string) =&gt;
  logSecurityEvent(&#x27;REGISTER_SUCCESS&#x27;, &#x27;INFO&#x27;, undefined, userId, email)

/** ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å¤±æ•— */
export const logRegisterFailure = (email: string, reason: string) =&gt;
  logSecurityEvent(&#x27;REGISTER_FAILURE&#x27;, &#x27;WARN&#x27;, { reason }, undefined, email)

/** TOTP æ¤œè¨¼å¤±æ•— */
export const logTotpFailure = (remainingAttempts: number) =&gt;
  logSecurityEvent(&#x27;TOTP_FAILURE&#x27;, &#x27;WARN&#x27;, { remainingAttempts })

/** TOTP URLãƒ­ãƒƒã‚¯ */
export const logTotpLocked = () =&gt;
  logSecurityEvent(&#x27;TOTP_LOCKED&#x27;, &#x27;CRITICAL&#x27;, undefined)

/** éµãƒšã‚¢ç”Ÿæˆå®Œäº† */
export const logKeyPairGenerated = (userId: string, fingerprintPrefix: string) =&gt;
  logSecurityEvent(&#x27;KEY_PAIR_GENERATE_SUCCESS&#x27;, &#x27;INFO&#x27;, { fingerprintPrefix }, userId)

/** ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ */
export const logUnauthorizedAccess = (path: string) =&gt;
  logSecurityEvent(&#x27;UNAUTHORIZED_ACCESS&#x27;, &#x27;ERROR&#x27;, { path })

/** æ¨©é™ä¸è¶³ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ */
export const logForbiddenAccess = (path: string, role: string) =&gt;
  logSecurityEvent(&#x27;FORBIDDEN_ACCESS&#x27;, &#x27;ERROR&#x27;, { path, role })
</pre>
<div class="box ok"><div class="bt">âœ… STEP 3 å®Œäº†ç¢ºèª</div><p>src/lib/securityLogger.ts ãŒä½œæˆã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 4: authService -->
<h1 class="s" id="step4">STEP 4 â€” src/services/authService.ts æ–°è¦ä½œæˆ <span class="tag-f">F-11ã€œF-14</span></h1>
<div class="step todo">
  <div class="sn"><div class="sl">STEP</div><div class="sv">4</div></div>
  <div class="sb">
    <div class="st">èªè¨¼ API Service ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆã™ã‚‹</div>
    <div class="ss">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(snake_case) â†” ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰(camelCase) å¤‰æ›ãƒ»ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›ã‚’ã“ã“ã§å¸åã™ã‚‹</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/services/authService.ts</span>
    <span class="fc-badge new">ğŸ†• æ–°è¦ä½œæˆ</span>
  </div>
  <div class="fc-body"><p class="fc-desc">POST /auth/loginãƒ»/auth/registerãƒ»/auth/totp/verify ã®3ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å‘¼ã³å‡ºã™ã‚µãƒ¼ãƒ“ã‚¹ã€‚<br>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åä¸ä¸€è‡´ï¼ˆdisplay_name, public_key_b64, otp ç­‰ï¼‰ã‚’ã™ã¹ã¦ã“ã“ã§å¤‰æ›ã™ã‚‹ã€‚</p></div>
</div>
<div class="box err">
  <div class="bt">âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã®å‹å®šç¾©ã®ä¸ä¸€è‡´ï¼ˆã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•å¤‰æ›ï¼‰</div>
  <table style="margin-top:8px">
    <tr><th>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿéš›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</th><th>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å‹ (types/api.ts)</th><th>å¤‰æ›æ–¹å‘</th></tr>
    <tr><td><code>display_name</code></td><td><code>displayName</code></td><td>ç™»éŒ²æ™‚: camelCase â†’ snake_case ã§é€ä¿¡</td></tr>
    <tr><td><code>public_key_b64</code></td><td><code>publicKeyKyberB64</code></td><td>ç™»éŒ²æ™‚: camelCase â†’ snake_case ã§é€ä¿¡</td></tr>
    <tr><td><code>otp</code></td><td><code>totp_code</code></td><td>TOTP: otp ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§é€ä¿¡ï¼ˆtypes/api.ts ã¨ç•°ãªã‚‹ï¼‰</td></tr>
    <tr><td><code>user.display_name</code></td><td><code>user.displayName</code></td><td>ãƒ­ã‚°ã‚¤ãƒ³å¿œç­”: snake_case â†’ camelCase ã«å¤‰æ›</td></tr>
    <tr><td>emailï¼ˆæœªè¿”å´ï¼‰</td><td><code>user.email</code></td><td>ãƒ­ã‚°ã‚¤ãƒ³å…¥åŠ›å€¤ã‚’ãã®ã¾ã¾ä¿æŒ</td></tr>
  </table>
</div>
<div class="clbl">frontend/src/services/authService.ts â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹</div>
<pre>// =============================================================
// ZeroSend â€” services/authService.ts
//
// ãƒ‘ã‚¹        : frontend/src/services/authService.ts
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : èªè¨¼ API å‘¼ã³å‡ºã—ã® Service ãƒ¬ã‚¤ãƒ¤ãƒ¼
//               ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(snake_case) â†” ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰(camelCase) å¤‰æ›
//               ProblemDetail â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›
//
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆåŸå‰‡:
//   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãã®ã¾ã¾ UI ã«éœ²å‡ºã—ãªã„
//   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ»ç§˜å¯†éµãªã©ã®æ©Ÿå¯†æƒ…å ±ã¯å¼•æ•°ã¨ã—ã¦ä¸€æ™‚çš„ã«ä¿æŒã™ã‚‹ã®ã¿
//   - å…¨ API ã‚³ãƒ¼ãƒ«ã¯ securityLogger ã§è¨˜éŒ²
//   - 429 / 423 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’é©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
//
// ä¾å­˜é–¢ä¿‚:
//   @/lib/apiClient        api, ApiError
//   @/lib/securityLogger   logSecurityEvent ç³»
// =============================================================

import { api, ApiError } from &#x27;@/lib/apiClient&#x27;
import {
  logLoginAttempt, logLoginSuccess, logLoginFailure,
  logRegisterAttempt, logRegisterSuccess, logRegisterFailure,
  logSecurityEvent,
} from &#x27;@/lib/securityLogger&#x27;
import type { UserRole } from &#x27;@/types/api&#x27;

// â”€â”€â”€ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿéš›ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ï¼ˆsnake_caseï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NOTE: types/api.ts ã® LoginResponse ã¨ã¯åˆ¥ã«å®šç¾©
//       ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ src/routes/auth.route.ts ã®å®Ÿè£…ã«å®Œå…¨æº–æ‹ 

interface BackendLoginResponse {
  access_token: string
  expires_in: number          // ç§’æ•°
  user: {
    id: string
    display_name: string      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ snake_case
    role: UserRole
    // NOTE: email / totpEnabled ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒè¿”ã•ãªã„ãŸã‚çœç•¥
  }
}

interface BackendRegisterResponse {
  user_id: string             // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ user_id ã®ã¿è¿”ã™
  key_fingerprint: string     // SHA3-256 ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
}

interface BackendTotpVerifyResponse {
  auth_token: string
  expires_in: number          // ç§’æ•° (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 600)
}

// â”€â”€â”€ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨æ­£è¦åŒ–å‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export interface NormalizedLoginResult {
  accessToken: string
  expiresIn: number           // ç§’æ•°
  user: {
    id: string
    displayName: string
    email: string             // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«å…¥åŠ›ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚’ä¿æŒ
    role: UserRole
    totpEnabled: boolean      // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒæœªè¿”å´ã®ãŸã‚åˆæœŸå€¤ false
  }
}

export interface NormalizedRegisterResult {
  userId: string
  keyFingerprint: string
}

export interface NormalizedTotpResult {
  authToken: string
  expiresIn: number
}

// â”€â”€â”€ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ› â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
// ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ãã®ã¾ã¾éœ²å‡ºã—ãªã„
// type ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§åˆ†å²ã—ã¦ UI å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›

function toUserFacingMessage(error: ApiError): string {
  const { status, problem } = error

  switch (status) {
    case 400:
      return &#x27;ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“&#x27;
    case 401:
      return &#x27;ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“&#x27;
    case 409:
      return &#x27;ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™&#x27;
    case 422:
      return &#x27;å…¥åŠ›å†…å®¹ã«ä¸å‚™ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„&#x27;
    case 423: {
      // URLãƒ­ãƒƒã‚¯ (TOTP 5å›å¤±æ•—)
      const remaining = (problem as Record&lt;string, unknown&gt;).remaining_attempts as number | undefined
      return remaining !== undefined
        ? `èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ®‹ã‚Šè©¦è¡Œå›æ•°: ${remaining}å›`
        : &#x27;èªè¨¼è©¦è¡Œå›æ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„&#x27;
    }
    case 429:
      return &#x27;ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„&#x27;
    case 500:
    case 502:
    case 503:
      return &#x27;ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„&#x27;
    case 0:
      return &#x27;ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„&#x27;
    default:
      return &#x27;äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ&#x27;
  }
}

// â”€â”€â”€ API å‘¼ã³å‡ºã—é–¢æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
 * POST /api/v1/auth/login
 *
 * @param email    - ãƒ­ã‚°ã‚¤ãƒ³ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param password - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆã“ã®é–¢æ•°ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®ã¿ã§ä¿æŒï¼‰
 * @returns        NormalizedLoginResult
 * @throws         Errorï¼ˆuserFacingMessageä»˜ãï¼‰
 */
export async function loginUser(
  email: string,
  password: string,
): Promise&lt;NormalizedLoginResult&gt; {
  logLoginAttempt(email)

  try {
    const raw = await api.post&lt;BackendLoginResponse&gt;(&#x27;auth/login&#x27;, {
      json: { email, password },
    })

    const result: NormalizedLoginResult = {
      accessToken: raw.access_token,
      expiresIn:   raw.expires_in,
      user: {
        id:          raw.user.id,
        displayName: raw.user.display_name,
        email,                        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœªè¿”å´ã®ãŸã‚å…¥åŠ›å€¤ã‚’ä½¿ç”¨
        role:        raw.user.role,
        totpEnabled: false,           // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æœªè¿”å´ã®ãŸã‚åˆæœŸå€¤
      },
    }

    logLoginSuccess(result.user.id, email)
    return result

  } catch (error) {
    const message = error instanceof ApiError
      ? toUserFacingMessage(error)
      : &#x27;ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ&#x27;

    logLoginFailure(email, error instanceof ApiError ? error.problem.type : &#x27;unknown&#x27;)

    throw new Error(message)
  }
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å‡¦ç†
 * POST /api/v1/auth/register
 *
 * NOTE: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã“ã®é–¢æ•°ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®ã¿ã§ä¿æŒã—ã€å®Œäº†å¾Œã«å‚ç…§ã‚’ç ´æ£„ã™ã‚‹
 *       å…¬é–‹éµ (publicKeyB64) ã®ã¿ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹ï¼ˆç§˜å¯†éµã¯çµ¶å¯¾ã«é€ã‚‰ãªã„ï¼‰
 *
 * @param email        - ç™»éŒ²ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 * @param displayName  - è¡¨ç¤ºå
 * @param password     - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆã“ã®é–¢æ•°ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®ã¿ï¼‰
 * @param publicKeyB64 - ML-KEM-768 å…¬é–‹éµ (Base64) â† ç§˜å¯†éµã§ã¯ãªã„
 * @returns            NormalizedRegisterResult
 * @throws             Errorï¼ˆuserFacingMessageä»˜ãï¼‰
 */
export async function registerUser(
  email: string,
  displayName: string,
  password: string,
  publicKeyB64: string,     // å…¬é–‹éµã®ã¿ï¼ç§˜å¯†éµã¯æ¸¡ã•ãªã„ã“ã¨
): Promise&lt;NormalizedRegisterResult&gt; {
  logRegisterAttempt(email)

  try {
    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒæœŸå¾…ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åï¼ˆsnake_caseï¼‰ã«å¤‰æ›
    const raw = await api.post&lt;BackendRegisterResponse&gt;(&#x27;auth/register&#x27;, {
      json: {
        email,
        display_name:   displayName,  // camelCase â†’ snake_case
        password,
        public_key_b64: publicKeyB64, // ãƒ•ãƒ­ãƒ³ãƒˆã® publicKeyKyberB64 â†’ backend ã® public_key_b64
        key_type:       &#x27;kyber768&#x27;,   // å›ºå®šå€¤: ML-KEM-768
      },
    })

    const result: NormalizedRegisterResult = {
      userId:         raw.user_id,
      keyFingerprint: raw.key_fingerprint,
    }

    logRegisterSuccess(result.userId, email)
    return result

  } catch (error) {
    const message = error instanceof ApiError
      ? toUserFacingMessage(error)
      : &#x27;ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ&#x27;

    logRegisterFailure(email, error instanceof ApiError ? error.problem.type : &#x27;unknown&#x27;)

    throw new Error(message)
  }
}

/**
 * TOTP äºŒè¦ç´ èªè¨¼ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ç”¨ï¼‰
 * POST /api/v1/auth/totp/verify
 *
 * @param urlToken  - ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ URLãƒˆãƒ¼ã‚¯ãƒ³
 * @param email     - å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆæœ¬äººç¢ºèªç”¨ï¼‰
 * @param otp       - 6æ¡ TOTP ã‚³ãƒ¼ãƒ‰
 * @returns         NormalizedTotpResult
 * @throws          TotpErrorï¼ˆremainingAttempts / isLocked ä»˜ãï¼‰
 */

export interface TotpError extends Error {
  remainingAttempts?: number
  isLocked: boolean
  statusCode: number
}

export async function verifyTotp(
  urlToken: string,
  email: string,
  otp: string,
): Promise&lt;NormalizedTotpResult&gt; {
  logSecurityEvent(&#x27;TOTP_ATTEMPT&#x27;, &#x27;INFO&#x27;, undefined, undefined, email)

  try {
    // NOTE: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã¯ `otp`ï¼ˆtypes/api.ts ã® totp_code ã¨ã¯ç•°ãªã‚‹ï¼‰
    const raw = await api.post&lt;BackendTotpVerifyResponse&gt;(&#x27;auth/totp/verify&#x27;, {
      json: {
        url_token: urlToken,
        email,
        otp,          // backend validator: otp (not otp_code, not totp_code)
      },
    })

    logSecurityEvent(&#x27;TOTP_SUCCESS&#x27;, &#x27;INFO&#x27;, undefined, undefined, email)

    return {
      authToken: raw.auth_token,
      expiresIn: raw.expires_in,
    }

  } catch (error) {
    if (error instanceof ApiError) {
      const remaining = (error.problem as Record&lt;string, unknown&gt;).remaining_attempts as number | undefined
      const isLocked  = error.status === 423

      if (isLocked) {
        logSecurityEvent(&#x27;TOTP_LOCKED&#x27;, &#x27;CRITICAL&#x27;)
      } else {
        logSecurityEvent(&#x27;TOTP_FAILURE&#x27;, &#x27;WARN&#x27;, { remainingAttempts: remaining })
      }

      const totpError = Object.assign(
        new Error(toUserFacingMessage(error)),
        {
          remainingAttempts: remaining,
          isLocked,
          statusCode: error.status,
        },
      ) as TotpError

      throw totpError
    }

    throw new Error(&#x27;TOTP èªè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ&#x27;)
  }
}
</pre>
<div class="box ok"><div class="bt">âœ… STEP 4 å®Œäº†ç¢ºèª</div><p>src/services/authService.ts ãŒä½œæˆã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 5: authStore -->
<h1 class="s" id="step5">STEP 5 â€” src/stores/authStore.ts ä¸Šæ›¸ãæ›´æ–° <span class="tag-f">F-12</span></h1>
<div class="step info">
  <div class="sn"><div class="sl">STEP</div><div class="sv">5</div></div>
  <div class="sb">
    <div class="st">authStore.ts ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã™ã‚‹ï¼ˆPhase 0 ã®é››å½¢ã‹ã‚‰ç½®ãæ›ãˆï¼‰</div>
    <div class="ss">è¿½åŠ ç‚¹: tokenExpiresAt / isTokenExpiringSoon / checkTokenExpiry()</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/stores/authStore.ts</span>
    <span class="fc-badge upd">ğŸ”„ ä¸Šæ›¸ãæ›´æ–°</span>
  </div>
  <div class="fc-body"><p class="fc-desc">Phase 0 ã®é››å½¢ã‹ã‚‰å®Œå…¨ç½®ãæ›ãˆã€‚setAuth ã« expiresIn å¼•æ•°ã‚’è¿½åŠ ã—ã€ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã®è‡ªå‹•ç®¡ç†ã¨30åˆ†å‰è­¦å‘Šã‚’å®Ÿè£…ã™ã‚‹ã€‚</p></div>
</div>
<div class="box warn"><div class="bt">âš ï¸ ä¸Šæ›¸ãç¢ºèª</div><p>æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Œå…¨ã«ç½®ãæ›ãˆã¾ã™ã€‚å¿…è¦ã§ã‚ã‚Œã°äº‹å‰ã« <code>cp src/stores/authStore.ts src/stores/authStore.ts.bak</code> ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</p></div>
<div class="clbl">frontend/src/stores/authStore.ts â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆä¸Šæ›¸ãï¼‰</div>
<pre>// =============================================================
// ZeroSend â€” stores/authStore.ts
//
// ãƒ‘ã‚¹        : frontend/src/stores/authStore.ts
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : JWT ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç®¡ç† Zustand ã‚¹ãƒˆã‚¢
//
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ:
//   [XSSå¯¾ç­–]   access_token ã¯ãƒ¡ãƒ¢ãƒªä¿æŒã®ã¿ï¼ˆlocalStorageãƒ»sessionStorage ä¸ä½¿ç”¨ï¼‰
//   [æœŸé™ç®¡ç†]  tokenExpiresAt ã§æœ‰åŠ¹æœŸé™è¿½è·¡ â†’ è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
//   [è­¦å‘Šé€šçŸ¥]  æœ‰åŠ¹æœŸé™ 30åˆ†å‰ã« isTokenExpiringSoon = true
//
// State:
//   accessToken        string | null    JWT Bearer ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆãƒ¡ãƒ¢ãƒªã®ã¿ï¼‰
//   tokenExpiresAt     number | null    æœ‰åŠ¹æœŸé™ Unix ãƒŸãƒªç§’
//   isTokenExpiringSoon boolean         æœ‰åŠ¹æœŸé™ã¾ã§30åˆ†ä»¥å†…
//   user               AuthUser | null  ãƒ­ã‚°ã‚¤ãƒ³ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
//   isAuthenticated    boolean          èªè¨¼çŠ¶æ…‹ãƒ•ãƒ©ã‚°
//
// Actions:
//   setAuth(token, user, expiresIn)  ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«å‘¼ã¶
//   logout()                         ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
//   getToken()                       apiClient ã® beforeRequest ã‹ã‚‰å‘¼ã¶
//   checkTokenExpiry()               å®šæœŸãƒã‚§ãƒƒã‚¯ç”¨ï¼ˆuseTokenExpiryWatch ã§ä½¿ç”¨ï¼‰
//
// ä¾å­˜é–¢ä¿‚:
//   zustand       ^5
//   @/types/api   UserRole
//   @/lib/securityLogger
// =============================================================

import { create } from &#x27;zustand&#x27;
import type { UserRole } from &#x27;@/types/api&#x27;
import { logForcedLogout, logLogout, logSecurityEvent } from &#x27;@/lib/securityLogger&#x27;

// â”€â”€â”€ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export interface AuthUser {
  id: string
  email: string
  displayName: string
  role: UserRole
  totpEnabled: boolean
}

// â”€â”€â”€ æœ‰åŠ¹æœŸé™è­¦å‘Šã—ãã„å€¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/** ã“ã®æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ã‚’åˆ‡ã£ãŸã‚‰ isTokenExpiringSoon = true */
const EXPIRY_WARN_THRESHOLD_MS = 30 * 60 * 1000  // 30åˆ†

// â”€â”€â”€ Store å‹å®šç¾© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface AuthState {
  // â”€â”€ State â”€â”€
  accessToken: string | null
  tokenExpiresAt: number | null        // Unix ãƒŸãƒªç§’ (null = æœªè¨­å®š)
  isTokenExpiringSoon: boolean         // 30åˆ†ä»¥å†…ã«æœŸé™åˆ‡ã‚Œ
  user: AuthUser | null
  isAuthenticated: boolean

  // â”€â”€ Actions â”€â”€

  /**
   * ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸæ™‚ã«å‘¼ã¶
   * @param token     JWT ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
   * @param user      ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
   * @param expiresIn ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé–“ï¼ˆç§’ï¼‰
   */
  setAuth: (token: string, user: AuthUser, expiresIn: number) =&gt; void

  /**
   * ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆé€šå¸¸ãƒ»å¼·åˆ¶å…±ç”¨ï¼‰
   * @param reason  çœç•¥æ™‚ã¯é€šå¸¸ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
   */
  logout: (reason?: &#x27;token_expired&#x27; | &#x27;unauthorized_401&#x27;) =&gt; void

  /**
   * apiClient ã® beforeRequest ãƒ•ãƒƒã‚¯ã‹ã‚‰å‘¼ã¶
   * ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œæ™‚ã¯ null ã‚’è¿”ã—ã¦ 401 ã‚’èª˜ç™ºã•ã›ã‚‹
   */
  getToken: () =&gt; string | null

  /**
   * ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
   * useTokenExpiryWatch ãƒ•ãƒƒã‚¯ãŒå®šæœŸçš„ã«å‘¼ã¶
   * æœŸé™åˆ‡ã‚Œæ¤œå‡ºæ™‚ã¯è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
   */
  checkTokenExpiry: () =&gt; void
}

// â”€â”€â”€ Store å®Ÿè£… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export const useAuthStore = create&lt;AuthState&gt;()((set, get) =&gt; ({
  // â”€â”€ åˆæœŸ State â”€â”€
  accessToken:         null,
  tokenExpiresAt:      null,
  isTokenExpiringSoon: false,
  user:                null,
  isAuthenticated:     false,

  // â”€â”€ setAuth â”€â”€
  setAuth: (token, user, expiresIn) =&gt; {
    const now = Date.now()
    const tokenExpiresAt = now + expiresIn * 1000
    const isTokenExpiringSoon = tokenExpiresAt - now &lt; EXPIRY_WARN_THRESHOLD_MS

    if (isTokenExpiringSoon) {
      logSecurityEvent(
        &#x27;TOKEN_NEAR_EXPIRY&#x27;,
        &#x27;WARN&#x27;,
        { remainingMs: tokenExpiresAt - now },
        user.id,
      )
    }

    set({
      accessToken: token,
      tokenExpiresAt,
      isTokenExpiringSoon,
      user,
      isAuthenticated: true,
    })
  },

  // â”€â”€ logout â”€â”€
  logout: (reason) =&gt; {
    const { user } = get()

    if (reason === &#x27;token_expired&#x27; || reason === &#x27;unauthorized_401&#x27;) {
      logForcedLogout(reason)
    } else if (user) {
      logLogout(user.id)
    }

    set({
      accessToken:         null,
      tokenExpiresAt:      null,
      isTokenExpiringSoon: false,
      user:                null,
      isAuthenticated:     false,
    })
  },

  // â”€â”€ getToken â”€â”€
  getToken: () =&gt; {
    const { accessToken, tokenExpiresAt } = get()

    if (!accessToken) return null

    // æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã¯è¿”ã•ãªã„ï¼ˆapiClient ã« null ã‚’è¿”ã—ã¦ 401 ã‚’èª˜ç™ºï¼‰
    if (tokenExpiresAt !== null &amp;&amp; Date.now() &gt;= tokenExpiresAt) {
      logSecurityEvent(&#x27;TOKEN_EXPIRED&#x27;, &#x27;WARN&#x27;)
      // logout ã¯ checkTokenExpiry ã«ä»»ã›ã‚‹ï¼ˆã“ã“ã§å‘¼ã¶ã¨ãƒ«ãƒ¼ãƒ—ã«ãªã‚‹å¯èƒ½æ€§ï¼‰
      return null
    }

    return accessToken
  },

  // â”€â”€ checkTokenExpiry â”€â”€
  checkTokenExpiry: () =&gt; {
    const { accessToken, tokenExpiresAt, user, isAuthenticated } = get()

    if (!isAuthenticated || !accessToken || tokenExpiresAt === null) return

    const now = Date.now()
    const remainingMs = tokenExpiresAt - now

    if (remainingMs &lt;= 0) {
      // æœŸé™åˆ‡ã‚Œ â†’ å¼·åˆ¶ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      logSecurityEvent(&#x27;TOKEN_EXPIRED&#x27;, &#x27;ERROR&#x27;, undefined, user?.id)
      get().logout(&#x27;token_expired&#x27;)
      return
    }

    // è­¦å‘Šã—ãã„å€¤ãƒã‚§ãƒƒã‚¯
    const shouldWarn = remainingMs &lt; EXPIRY_WARN_THRESHOLD_MS
    const { isTokenExpiringSoon } = get()

    if (shouldWarn &amp;&amp; !isTokenExpiringSoon) {
      logSecurityEvent(
        &#x27;TOKEN_NEAR_EXPIRY&#x27;,
        &#x27;WARN&#x27;,
        { remainingMinutes: Math.floor(remainingMs / 60_000) },
        user?.id,
      )
      set({ isTokenExpiringSoon: true })
    }
  },
}))
</pre>
<div class="box ok"><div class="bt">âœ… STEP 5 å®Œäº†ç¢ºèª</div><p>src/stores/authStore.ts ãŒæ›´æ–°ã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 6: LoginPage -->
<h1 class="s" id="step6">STEP 6 â€” src/pages/LoginPage.tsx ä¸Šæ›¸ãæ›´æ–° <span class="tag-f">F-11</span><span class="tag-f">F-12</span></h1>
<div class="step todo">
  <div class="sn"><div class="sl">STEP</div><div class="sv">6</div></div>
  <div class="sb">
    <div class="st">LoginPage.tsx ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã™ã‚‹</div>
    <div class="ss">useTokenExpiryWatch ãƒ•ãƒƒã‚¯ã‚‚åŒãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã‚€ã€‚App.tsx ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ã†</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/pages/LoginPage.tsx</span>
    <span class="fc-badge upd">ğŸ”„ ä¸Šæ›¸ãæ›´æ–°</span>
  </div>
  <div class="fc-body"><p class="fc-desc">F-11: ZeroSend ãƒ­ã‚´ + Quantum-Safe ãƒãƒƒã‚¸ + ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ  UIã€‚<br>F-12: useTokenExpiryWatch ãƒ•ãƒƒã‚¯ã‚’ export â€” App.tsx ã® AppShell ã‹ã‚‰å‘¼ã³å‡ºã—60ç§’ã”ã¨ã«ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ã€‚</p></div>
</div>
<div class="clbl">frontend/src/pages/LoginPage.tsx â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆä¸Šæ›¸ãï¼‰</div>
<pre>// =============================================================
// ZeroSend â€” pages/LoginPage.tsx
//
// ãƒ‘ã‚¹        : frontend/src/pages/LoginPage.tsx
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : F-11 ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ UI / F-12 JWT å–å¾—ãƒ»ã‚¹ãƒˆã‚¢ç®¡ç†
//               ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ æº–æ‹ ãƒ‡ã‚¶ã‚¤ãƒ³
//               ZeroSend ãƒ­ã‚´ + Quantum-Safe ãƒãƒƒã‚¸è¡¨ç¤º
//
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ:
//   - æ—¢èªè¨¼æ¸ˆã¿ã®å ´åˆã¯ / ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼‰
//   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ autocomplete=&quot;current-password&quot;
//   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªè¡¨ç¤ºã®ã¿ï¼ˆè©³ç´°éš è”½ï¼‰
//   - ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œ setAuth() ã«ã¦ expiresIn ã‚’æ¸¡ã—æœ‰åŠ¹æœŸé™ç®¡ç†ã‚’é–‹å§‹
//   - ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ç›£è¦–ã¯ useTokenExpiryWatch ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã§å®Ÿè£… (F-12)
//
// ä¾å­˜é–¢ä¿‚:
//   react-router-dom     ^7   useNavigate / Link / Navigate
//   @/services/authService    loginUser
//   @/stores/authStore        useAuthStore (setAuth / isAuthenticated)
// =============================================================

import { useState, useEffect, useRef, useCallback } from &#x27;react&#x27;
import { useNavigate, Link, Navigate } from &#x27;react-router-dom&#x27;
import { loginUser } from &#x27;@/services/authService&#x27;
import { useAuthStore } from &#x27;@/stores/authStore&#x27;

// â”€â”€â”€ ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ç›£è¦–ãƒ•ãƒƒã‚¯ (F-12) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * JWTæœ‰åŠ¹æœŸé™ã®å®šæœŸãƒã‚§ãƒƒã‚¯ãƒ•ãƒƒã‚¯
 * ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®å…¨ç”»é¢ã§ä½¿ç”¨ï¼ˆApp.tsx ã«é…ç½®ã‚’æ¨å¥¨ï¼‰
 * æœŸé™åˆ‡ã‚Œæ¤œå‡ºæ™‚ â†’ authStore.checkTokenExpiry() â†’ è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
 *
 * @example
 * // App.tsx å†…ã§å‘¼ã¶
 * useTokenExpiryWatch()
 */
export function useTokenExpiryWatch(intervalMs: number = 60_000): void {
  const checkTokenExpiry = useAuthStore(s =&gt; s.checkTokenExpiry)
  const isAuthenticated  = useAuthStore(s =&gt; s.isAuthenticated)

  useEffect(() =&gt; {
    if (!isAuthenticated) return

    // å³æ™‚1å›ãƒã‚§ãƒƒã‚¯
    checkTokenExpiry()

    const timer = setInterval(checkTokenExpiry, intervalMs)
    return () =&gt; clearInterval(timer)
  }, [isAuthenticated, checkTokenExpiry, intervalMs])
}

// â”€â”€â”€ LoginPage ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function LoginPage() {
  const navigate        = useNavigate()
  const isAuthenticated = useAuthStore(s =&gt; s.isAuthenticated)
  const setAuth         = useAuthStore(s =&gt; s.setAuth)

  const [email,       setEmail]       = useState(&#x27;&#x27;)
  const [password,    setPassword]    = useState(&#x27;&#x27;)
  const [error,       setError]       = useState&lt;string | null&gt;(null)
  const [isLoading,   setIsLoading]   = useState(false)
  const [showPassword, setShowPassword] = useState(false)

  const emailRef = useRef&lt;HTMLInputElement&gt;(null)

  // ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  useEffect(() =&gt; {
    emailRef.current?.focus()
  }, [])

  // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒˆãƒƒãƒ—ã¸
  if (isAuthenticated) {
    return &lt;Navigate to=&quot;/&quot; replace /&gt;
  }

  // â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ â”€â”€
  const handleSubmit = useCallback(async (e: React.FormEvent) =&gt; {
    e.preventDefault()
    setError(null)

    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const trimmedEmail = email.trim().toLowerCase()
    if (!trimmedEmail || !password) {
      setError(&#x27;ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#x27;)
      return
    }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(trimmedEmail)) {
      setError(&#x27;æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#x27;)
      return
    }
    if (password.length &lt; 8) {
      setError(&#x27;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã§ã™&#x27;)
      return
    }

    setIsLoading(true)

    try {
      const result = await loginUser(trimmedEmail, password)

      // F-12: setAuth ã« expiresIn ã‚’æ¸¡ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ç®¡ç†ã‚’é–‹å§‹
      setAuth(result.accessToken, result.user, result.expiresIn)

      navigate(&#x27;/&#x27;, { replace: true })

    } catch (err) {
      setError(err instanceof Error ? err.message : &#x27;ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ&#x27;)
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      setPassword(&#x27;&#x27;)
    } finally {
      setIsLoading(false)
    }
  }, [email, password, setAuth, navigate])

  // â”€â”€ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â”€â”€
  return (
    &lt;div className=&quot;min-h-screen bg-gray-950 flex items-center justify-center px-4&quot;&gt;

      {/* èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ */}
      &lt;div
        className=&quot;absolute inset-0 opacity-[0.03]&quot;
        style={{
          backgroundImage: `linear-gradient(rgba(99,102,241,0.5) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(99,102,241,0.5) 1px, transparent 1px)`,
          backgroundSize: &#x27;40px 40px&#x27;,
        }}
      /&gt;

      &lt;div className=&quot;relative w-full max-w-md&quot;&gt;

        {/* â”€â”€â”€ ãƒ­ã‚´ + ãƒãƒƒã‚¸ â”€â”€â”€ */}
        &lt;div className=&quot;text-center mb-8&quot;&gt;
          &lt;div className=&quot;inline-flex items-center gap-3 mb-3&quot;&gt;
            &lt;div className=&quot;w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-900/50&quot;&gt;
              &lt;svg className=&quot;w-5 h-5 text-white&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                  d=&quot;M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z&quot; /&gt;
              &lt;/svg&gt;
            &lt;/div&gt;
            &lt;span className=&quot;text-2xl font-bold text-white tracking-tight&quot;&gt;ZeroSend&lt;/span&gt;
          &lt;/div&gt;

          &lt;p className=&quot;text-gray-400 text-sm mb-3&quot;&gt;é‡å­è€æ€§ãƒ•ã‚¡ã‚¤ãƒ«è»¢é€ã‚·ã‚¹ãƒ†ãƒ &lt;/p&gt;

          {/* Quantum-Safe ãƒãƒƒã‚¸ */}
          &lt;div className=&quot;inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-950 border border-emerald-800 rounded-full&quot;&gt;
            &lt;span className=&quot;w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse&quot; /&gt;
            &lt;span className=&quot;text-emerald-400 text-xs font-mono font-semibold tracking-wide&quot;&gt;
              ML-KEM-768 / Quantum-Safe
            &lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        {/* â”€â”€â”€ ãƒ­ã‚°ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ â”€â”€â”€ */}
        &lt;div className=&quot;bg-gray-900 border border-gray-800 rounded-2xl p-8 shadow-2xl&quot;&gt;
          &lt;h1 className=&quot;text-lg font-semibold text-white mb-6&quot;&gt;ãƒ­ã‚°ã‚¤ãƒ³&lt;/h1&gt;

          &lt;form onSubmit={handleSubmit} noValidate&gt;

            {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ */}
            &lt;div className=&quot;mb-4&quot;&gt;
              &lt;label htmlFor=&quot;email&quot; className=&quot;block text-sm font-medium text-gray-300 mb-1.5&quot;&gt;
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
              &lt;/label&gt;
              &lt;input
                id=&quot;email&quot;
                ref={emailRef}
                type=&quot;email&quot;
                autoComplete=&quot;email&quot;
                inputMode=&quot;email&quot;
                required
                value={email}
                onChange={e =&gt; { setEmail(e.target.value); setError(null) }}
                disabled={isLoading}
                placeholder=&quot;you@example.com&quot;
                className={`
                  w-full px-3.5 py-2.5 bg-gray-800 border rounded-lg text-white text-sm
                  placeholder-gray-500 transition-colors duration-150 outline-none
                  focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50
                  disabled:opacity-50 disabled:cursor-not-allowed
                  ${error ? &#x27;border-red-700&#x27; : &#x27;border-gray-700&#x27;}
                `}
              /&gt;
            &lt;/div&gt;

            {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ */}
            &lt;div className=&quot;mb-6&quot;&gt;
              &lt;label htmlFor=&quot;password&quot; className=&quot;block text-sm font-medium text-gray-300 mb-1.5&quot;&gt;
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
              &lt;/label&gt;
              &lt;div className=&quot;relative&quot;&gt;
                &lt;input
                  id=&quot;password&quot;
                  type={showPassword ? &#x27;text&#x27; : &#x27;password&#x27;}
                  autoComplete=&quot;current-password&quot;
                  required
                  value={password}
                  onChange={e =&gt; { setPassword(e.target.value); setError(null) }}
                  disabled={isLoading}
                  placeholder=&quot;â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢&quot;
                  className={`
                    w-full px-3.5 py-2.5 pr-10 bg-gray-800 border rounded-lg text-white text-sm
                    placeholder-gray-500 transition-colors duration-150 outline-none
                    focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50
                    disabled:opacity-50 disabled:cursor-not-allowed
                    ${error ? &#x27;border-red-700&#x27; : &#x27;border-gray-700&#x27;}
                  `}
                /&gt;
                {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ */}
                &lt;button
                  type=&quot;button&quot;
                  onClick={() =&gt; setShowPassword(v =&gt; !v)}
                  tabIndex={-1}
                  className=&quot;absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors&quot;
                  aria-label={showPassword ? &#x27;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’éš ã™&#x27; : &#x27;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º&#x27;}
                &gt;
                  {showPassword ? (
                    &lt;svg className=&quot;w-4 h-4&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                      &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                        d=&quot;M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21&quot; /&gt;
                    &lt;/svg&gt;
                  ) : (
                    &lt;svg className=&quot;w-4 h-4&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                      &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                        d=&quot;M15 12a3 3 0 11-6 0 3 3 0 016 0z&quot; /&gt;
                      &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                        d=&quot;M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z&quot; /&gt;
                    &lt;/svg&gt;
                  )}
                &lt;/button&gt;
              &lt;/div&gt;
            &lt;/div&gt;

            {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
            {error &amp;&amp; (
              &lt;div
                role=&quot;alert&quot;
                className=&quot;mb-4 flex items-start gap-2.5 px-3.5 py-2.5 bg-red-950/60 border border-red-800 rounded-lg&quot;
              &gt;
                &lt;svg className=&quot;w-4 h-4 text-red-400 mt-0.5 shrink-0&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                  &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                    d=&quot;M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z&quot; /&gt;
                &lt;/svg&gt;
                &lt;span className=&quot;text-red-300 text-sm&quot;&gt;{error}&lt;/span&gt;
              &lt;/div&gt;
            )}

            {/* ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */}
            &lt;button
              type=&quot;submit&quot;
              disabled={isLoading}
              className=&quot;
                w-full py-2.5 px-4 bg-indigo-600 hover:bg-indigo-500 disabled:bg-indigo-800
                text-white font-semibold text-sm rounded-lg transition-colors duration-150
                disabled:cursor-not-allowed flex items-center justify-center gap-2
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900
              &quot;
            &gt;
              {isLoading ? (
                &lt;&gt;
                  &lt;svg className=&quot;w-4 h-4 animate-spin&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot;&gt;
                    &lt;circle className=&quot;opacity-25&quot; cx=&quot;12&quot; cy=&quot;12&quot; r=&quot;10&quot; stroke=&quot;currentColor&quot; strokeWidth=&quot;4&quot; /&gt;
                    &lt;path className=&quot;opacity-75&quot; fill=&quot;currentColor&quot; d=&quot;M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z&quot; /&gt;
                  &lt;/svg&gt;
                  &lt;span&gt;èªè¨¼ä¸­...&lt;/span&gt;
                &lt;/&gt;
              ) : &#x27;ãƒ­ã‚°ã‚¤ãƒ³&#x27;}
            &lt;/button&gt;
          &lt;/form&gt;

          {/* ç™»éŒ²ãƒªãƒ³ã‚¯ */}
          &lt;p className=&quot;mt-6 text-center text-sm text-gray-500&quot;&gt;
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ãªã„æ–¹ã¯{&#x27; &#x27;}
            &lt;Link
              to=&quot;/register&quot;
              className=&quot;text-indigo-400 hover:text-indigo-300 transition-colors font-medium&quot;
            &gt;
              æ–°è¦ç™»éŒ²
            &lt;/Link&gt;
          &lt;/p&gt;
        &lt;/div&gt;

        {/* ãƒ•ãƒƒã‚¿ãƒ¼æ³¨è¨˜ */}
        &lt;p className=&quot;mt-4 text-center text-xs text-gray-600&quot;&gt;
          ZeroSend â€” NIST FIPS 203 ML-KEM-768 Â· AES-256-GCM
        &lt;/p&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</pre>
<div class="box ok"><div class="bt">âœ… STEP 6 å®Œäº†ç¢ºèª</div><p>src/pages/LoginPage.tsx ãŒæ›´æ–°ã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 7: RegisterPage -->
<h1 class="s" id="step7">STEP 7 â€” src/pages/RegisterPage.tsx æ–°è¦ä½œæˆ <span class="tag-f">F-13ï¼ˆæ ¸å¿ƒï¼‰</span></h1>
<div class="step sec-step">
  <div class="sn"><div class="sl">STEP</div><div class="sv">7</div></div>
  <div class="sb">
    <div class="st">ğŸ” RegisterPage.tsx ã‚’æ–°è¦ä½œæˆã™ã‚‹ï¼ˆML-KEM-768 éµãƒšã‚¢ç”Ÿæˆã®æ ¸å¿ƒå®Ÿè£…ï¼‰</div>
    <div class="ss">ç§˜å¯†éµã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‡¦ç†ãŒæœ€é‡è¦ã€‚secretKey ã‚’ React state ã«é•·æœŸä¿æŒã—ãªã„ã“ã¨</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/pages/RegisterPage.tsx</span>
    <span class="fc-badge new sec">ğŸ†• æ–°è¦ä½œæˆ ğŸ” æœ€é‡è¦</span>
  </div>
  <div class="fc-body"><p class="fc-desc">ML-KEM-768 éµãƒšã‚¢ã‚’ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§ç”Ÿæˆã—ã€ç§˜å¯†éµã‚’ IndexedDB ã®ã¿ã«ä¿å­˜ã€å…¬é–‹éµã®ã¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢ã€‚</p></div>
</div>
<div class="security-critical">
  <div class="sc-title">ğŸ” éµãƒšã‚¢å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆå¿…ãšå®ˆã‚‹ã“ã¨ï¼‰</div>
  <ul>
    <li><strong>â‘  éµç”Ÿæˆ:</strong> ml_kem768.keygen() â†’ å†…éƒ¨ã§ crypto.getRandomValues()ï¼ˆCSPRNGï¼‰ä½¿ç”¨</li>
    <li><strong>â‘¡ ç§˜å¯†éµ:</strong> secretKeyRef.currentï¼ˆuseRefï¼‰ã«ä¸€æ™‚ä¿æŒã€‚useState ã¸ã®é•·æœŸä¿æŒã¯ã—ãªã„</li>
    <li><strong>â‘¢ IndexedDB ä¿å­˜:</strong> storePrivateKey(userId, secretKey) â†’ ä¿å­˜å®Œäº†å¾Œã™ãã«å‚ç…§ã‚’ã‚¯ãƒªã‚¢</li>
    <li><strong>â‘£ ã‚µãƒ¼ãƒãƒ¼é€ä¿¡:</strong> registerUser(..., publicKeyB64) â†’ å…¬é–‹éµã®ã¿ã€‚secretKey å¼•æ•°ã¯å­˜åœ¨ã—ãªã„</li>
    <li><strong>â‘¤ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—:</strong> ç™»éŒ²å®Œäº†å¾Œ secretKeyRef.current = null â†’ GC ã«ä»»ã›ã‚‹</li>
  </ul>
</div>
<div class="clbl">frontend/src/pages/RegisterPage.tsx â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹</div>
<pre>// =============================================================
// ZeroSend â€” pages/RegisterPage.tsx
//
// ãƒ‘ã‚¹        : frontend/src/pages/RegisterPage.tsx
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : F-13 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ç”»é¢ + ML-KEM-768 éµãƒšã‚¢ç”Ÿæˆ
//               @noble/post-quantum ã® ml_kem768.keygen() ã‚’ä½¿ç”¨
//               ç§˜å¯†éµã¯ IndexedDB ã«ã®ã¿ä¿å­˜ï¼ˆã‚µãƒ¼ãƒãƒ¼ã«ã¯çµ¶å¯¾ã«é€ã‚‰ãªã„ï¼‰
//               å…¬é–‹éµã®ã¿ POST /auth/register ã§é€ä¿¡
//
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆï¼ˆæœ€é‡è¦ï¼‰:
//   [éµç”Ÿæˆ]   ml_kem768.keygen() ã¯å†…éƒ¨ã§ crypto.getRandomValues() ã‚’ä½¿ç”¨ï¼ˆCSPRNGï¼‰
//   [ç§˜å¯†éµ]   Uint8Array ã®ã¾ã¾ IndexedDB ã«ä¿å­˜ã€‚React state ã§ã¯ä¸€æ™‚ä¿æŒã®ã¿
//   [ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—] ç™»éŒ²å®Œäº†å¾Œã« React state ã‹ã‚‰ç§˜å¯†éµå‚ç…§ã‚’å‰Šé™¤
//   [å…¬é–‹éµã®ã¿é€ä¿¡] registerUser() ã¯ publicKeyB64 ã®ã¿å—ã‘å–ã‚‹ï¼ˆç§˜å¯†éµå¼•æ•°ãªã—ï¼‰
//   [ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ] Web Crypto API SHA-256 ã§å…¬é–‹éµã‚’è¡¨ç¤ºï¼ˆå†…å®¹ç¢ºèªç”¨ï¼‰
//
// ä¾å­˜é–¢ä¿‚:
//   @noble/post-quantum/ml-kem   ml_kem768.keygen()
//   react-router-dom              Navigate / useNavigate / Link
//   @/services/authService        registerUser()
//   @/lib/keyStorage              storePrivateKey()
//   @/lib/securityLogger          logKeyPairGenerated()
//   @/stores/authStore            isAuthenticated
// =============================================================

import { useState, useEffect, useCallback, useRef } from &#x27;react&#x27;
import { useNavigate, Link, Navigate } from &#x27;react-router-dom&#x27;
import { ml_kem768 } from &#x27;@noble/post-quantum/ml-kem&#x27;
import { registerUser } from &#x27;@/services/authService&#x27;
import { storePrivateKey } from &#x27;@/lib/keyStorage&#x27;
import { logSecurityEvent, logKeyPairGenerated } from &#x27;@/lib/securityLogger&#x27;
import { useAuthStore } from &#x27;@/stores/authStore&#x27;

// â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: Uint8Array â†’ Base64 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * Uint8Array ã‚’ Base64 æ–‡å­—åˆ—ã«å¤‰æ›
 * btoa + String.fromCharCode ã‚’ä½¿ç”¨ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº– APIï¼‰
 */
function uint8ArrayToBase64(bytes: Uint8Array): string {
  let binary = &#x27;&#x27;
  const len = bytes.byteLength
  for (let i = 0; i &lt; len; i++) {
    binary += String.fromCharCode(bytes[i])
  }
  return btoa(binary)
}

// â”€â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: å…¬é–‹éµãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

/**
 * å…¬é–‹éµã® SHA-256 ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆã‚’ç”Ÿæˆ
 * Web Crypto API ä½¿ç”¨ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ï¼‰
 * è¡¨ç¤ºå½¢å¼: &quot;ab:cd:ef:12:34:56&quot; (å…ˆé ­6ãƒã‚¤ãƒˆ)
 *
 * NOTE: SHA3-256 ã‚’ä½¿ç”¨ã—ãŸã„å ´åˆã¯ @noble/hashes/sha3 ã‚’è¿½åŠ ã™ã‚‹ã“ã¨
 *       ç¾æ™‚ç‚¹ã¯ Web Crypto ã® SHA-256 ã§ä»£æ›¿ï¼ˆè¡¨ç¤ºç›®çš„ã®ãŸã‚ååˆ†ï¼‰
 */
async function computePublicKeyFingerprint(publicKey: Uint8Array): Promise&lt;string&gt; {
  const hashBuffer = await crypto.subtle.digest(&#x27;SHA-256&#x27;, publicKey)
  const hashArray  = Array.from(new Uint8Array(hashBuffer))
  // å…ˆé ­8ãƒã‚¤ãƒˆã‚’ &quot;XX:XX:XX:XX:XX:XX:XX:XX&quot; å½¢å¼ã§è¡¨ç¤º
  return hashArray
    .slice(0, 8)
    .map(b =&gt; b.toString(16).padStart(2, &#x27;0&#x27;))
    .join(&#x27;:&#x27;)
}

// â”€â”€â”€ éµãƒšã‚¢ç”ŸæˆçŠ¶æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type KeyGenStatus = &#x27;idle&#x27; | &#x27;generating&#x27; | &#x27;ready&#x27; | &#x27;error&#x27;

interface GeneratedKeypair {
  publicKeyB64: string      // ã‚µãƒ¼ãƒãƒ¼é€ä¿¡ç”¨ï¼ˆå®‰å…¨ï¼‰
  secretKey: Uint8Array     // IndexedDB ä¿å­˜ç”¨ï¼ˆçµ¶å¯¾ã«ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‰ãªã„ï¼‰
  fingerprint: string       // UI è¡¨ç¤ºç”¨ãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ
}

// â”€â”€â”€ RegisterPage ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function RegisterPage() {
  const navigate        = useNavigate()
  const isAuthenticated = useAuthStore(s =&gt; s.isAuthenticated)

  // ãƒ•ã‚©ãƒ¼ãƒ çŠ¶æ…‹
  const [email,          setEmail]          = useState(&#x27;&#x27;)
  const [displayName,    setDisplayName]    = useState(&#x27;&#x27;)
  const [password,       setPassword]       = useState(&#x27;&#x27;)
  const [confirmPw,      setConfirmPw]      = useState(&#x27;&#x27;)
  const [showPassword,   setShowPassword]   = useState(false)

  // éµãƒšã‚¢çŠ¶æ…‹
  const [keyGenStatus,   setKeyGenStatus]   = useState&lt;KeyGenStatus&gt;(&#x27;idle&#x27;)
  const [keypair,        setKeypair]        = useState&lt;GeneratedKeypair | null&gt;(null)

  // é€ä¿¡çŠ¶æ…‹
  const [isSubmitting,   setIsSubmitting]   = useState(false)
  const [error,          setError]          = useState&lt;string | null&gt;(null)
  const [success,        setSuccess]        = useState(false)

  // ç™»éŒ²å®Œäº†å¾Œã«ä¸€æ™‚ä¿æŒã—ãŸç§˜å¯†éµã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ãŸã‚ã® ref
  const secretKeyRef = useRef&lt;Uint8Array | null&gt;(null)

  // æ—¢èªè¨¼æ¸ˆã¿ãªã‚‰ãƒˆãƒƒãƒ—ã¸
  if (isAuthenticated) {
    return &lt;Navigate to=&quot;/&quot; replace /&gt;
  }

  // â”€â”€ éµãƒšã‚¢ç”Ÿæˆ â”€â”€
  // eslint-disable-next-line react-hooks/rules-of-hooks
  const generateKeypair = useCallback(async () =&gt; {
    setKeyGenStatus(&#x27;generating&#x27;)
    setKeypair(null)

    try {
      logSecurityEvent(&#x27;KEY_PAIR_GENERATE_START&#x27;, &#x27;INFO&#x27;)

      // ML-KEM-768 éµãƒšã‚¢ç”Ÿæˆ
      // @noble/post-quantum ã¯å†…éƒ¨ã§ crypto.getRandomValues() ã‚’ä½¿ç”¨ï¼ˆCSPRNGæº–æ‹ ï¼‰
      const { publicKey, secretKey } = ml_kem768.keygen()

      const publicKeyB64  = uint8ArrayToBase64(publicKey)
      const fingerprint   = await computePublicKeyFingerprint(publicKey)

      // ç§˜å¯†éµã¯ ref ã«ã‚‚ä¿æŒï¼ˆsubmit æ™‚ã® IndexedDB ä¿å­˜ç”¨ï¼‰
      secretKeyRef.current = secretKey

      setKeypair({ publicKeyB64, secretKey, fingerprint })
      setKeyGenStatus(&#x27;ready&#x27;)

      logSecurityEvent(&#x27;KEY_PAIR_GENERATE_SUCCESS&#x27;, &#x27;INFO&#x27;, {
        fingerprintPrefix: fingerprint.split(&#x27;:&#x27;).slice(0, 3).join(&#x27;:&#x27;),
        publicKeyLengthBytes: publicKey.byteLength,
      })

    } catch (err) {
      setKeyGenStatus(&#x27;error&#x27;)
      logSecurityEvent(&#x27;KEY_PAIR_GENERATE_START&#x27;, &#x27;ERROR&#x27;, {
        error: err instanceof Error ? err.message : &#x27;unknown&#x27;,
      })
    }
  }, [])

  // ãƒã‚¦ãƒ³ãƒˆæ™‚ã«éµãƒšã‚¢ç”Ÿæˆé–‹å§‹
  // eslint-disable-next-line react-hooks/rules-of-hooks
  useEffect(() =&gt; {
    generateKeypair()

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: ã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ç§˜å¯†éµå‚ç…§ã‚’ã‚¯ãƒªã‚¢
    return () =&gt; {
      secretKeyRef.current = null
    }
  }, [generateKeypair])

  // â”€â”€ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯ â”€â”€
  const passwordStrength = getPasswordStrength(password)

  // â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ â”€â”€
  const handleSubmit = useCallback(async (e: React.FormEvent) =&gt; {
    e.preventDefault()
    setError(null)

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const trimmedEmail = email.trim().toLowerCase()
    const trimmedName  = displayName.trim()

    if (!trimmedEmail || !trimmedName || !password || !confirmPw) {
      setError(&#x27;ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#x27;)
      return
    }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    if (!emailRegex.test(trimmedEmail)) {
      setError(&#x27;æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„&#x27;)
      return
    }
    if (password !== confirmPw) {
      setError(&#x27;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“&#x27;)
      return
    }
    if (passwordStrength.score &lt; 2) {
      setError(&#x27;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚ˆã‚Šå¼·å›ºã«ã—ã¦ãã ã•ã„ï¼ˆ8æ–‡å­—ä»¥ä¸Šã€æ•°å­—ãƒ»è¨˜å·ã‚’å«ã‚€ï¼‰&#x27;)
      return
    }
    if (!keypair || keyGenStatus !== &#x27;ready&#x27;) {
      setError(&#x27;éµãƒšã‚¢ã®ç”ŸæˆãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã¤ã‹å†ç”Ÿæˆã—ã¦ãã ã•ã„&#x27;)
      return
    }

    setIsSubmitting(true)

    try {
      // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² API å‘¼ã³å‡ºã—ï¼ˆå…¬é–‹éµã®ã¿é€ä¿¡ï¼‰
      const result = await registerUser(
        trimmedEmail,
        trimmedName,
        password,
        keypair.publicKeyB64,  // å…¬é–‹éµã®ã¿ï¼ç§˜å¯†éµã¯é€ã‚‰ãªã„
      )

      // 2. ç§˜å¯†éµã‚’ IndexedDB ã«ä¿å­˜ï¼ˆuserId ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨ï¼‰
      //    NOTE: result.userId å–å¾—å¾Œã«å³åº§ã«ä¿å­˜ã™ã‚‹
      try {
        logSecurityEvent(&#x27;KEY_PAIR_STORE_SUCCESS&#x27;, &#x27;INFO&#x27;, undefined, result.userId)
        await storePrivateKey(result.userId, keypair.secretKey)
        logKeyPairGenerated(result.userId, keypair.fingerprint.split(&#x27;:&#x27;).slice(0, 3).join(&#x27;:&#x27;))
      } catch (storeErr) {
        // IndexedDB ä¿å­˜å¤±æ•—ã¯è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ï¼ˆå¾©å·ä¸èƒ½ã«ãªã‚‹ï¼‰
        logSecurityEvent(&#x27;KEY_PAIR_STORE_FAILURE&#x27;, &#x27;CRITICAL&#x27;, {
          userId: result.userId,
          error: storeErr instanceof Error ? storeErr.message : &#x27;unknown&#x27;,
        })
        throw new Error(
          &#x27;æš—å·éµã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ä¿¡ã§ããªããªã‚Šã¾ã™ã€‚&#x27; +
          &#x27;å†ç™»éŒ²ã™ã‚‹ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã® IndexedDB è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚&#x27;
        )
      }

      // 3. React state ã‹ã‚‰ç§˜å¯†éµå‚ç…§ã‚’ã‚¯ãƒªã‚¢ï¼ˆGC ã«ä»»ã›ã‚‹ï¼‰
      secretKeyRef.current = null
      setKeypair(prev =&gt; prev ? { ...prev, secretKey: new Uint8Array(0) } : null)

      setSuccess(true)

      // 3ç§’å¾Œã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
      setTimeout(() =&gt; navigate(&#x27;/login&#x27;, { replace: true }), 3000)

    } catch (err) {
      setError(err instanceof Error ? err.message : &#x27;ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ&#x27;)
    } finally {
      setIsSubmitting(false)
    }
  }, [email, displayName, password, confirmPw, keypair, keyGenStatus,
      passwordStrength.score, navigate])

  // â”€â”€ ç™»éŒ²æˆåŠŸç”»é¢ â”€â”€
  if (success) {
    return (
      &lt;div className=&quot;min-h-screen bg-gray-950 flex items-center justify-center px-4&quot;&gt;
        &lt;div className=&quot;text-center max-w-sm&quot;&gt;
          &lt;div className=&quot;w-16 h-16 bg-emerald-900 border border-emerald-700 rounded-full flex items-center justify-center mx-auto mb-4&quot;&gt;
            &lt;svg className=&quot;w-8 h-8 text-emerald-400&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
              &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; d=&quot;M5 13l4 4L19 7&quot; /&gt;
            &lt;/svg&gt;
          &lt;/div&gt;
          &lt;h2 className=&quot;text-xl font-bold text-white mb-2&quot;&gt;ç™»éŒ²å®Œäº†&lt;/h2&gt;
          &lt;p className=&quot;text-gray-400 text-sm mb-2&quot;&gt;é‡å­è€æ€§éµãƒšã‚¢ãŒã“ã®ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ&lt;/p&gt;
          &lt;p className=&quot;text-gray-500 text-xs&quot;&gt;ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ç§»å‹•ã—ã¾ã™...&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    )
  }

  // â”€â”€ ãƒ¡ã‚¤ãƒ³ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  â”€â”€
  return (
    &lt;div className=&quot;min-h-screen bg-gray-950 flex items-center justify-center px-4 py-10&quot;&gt;

      {/* èƒŒæ™¯ã‚°ãƒªãƒƒãƒ‰ */}
      &lt;div
        className=&quot;absolute inset-0 opacity-[0.03]&quot;
        style={{
          backgroundImage: `linear-gradient(rgba(99,102,241,0.5) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(99,102,241,0.5) 1px, transparent 1px)`,
          backgroundSize: &#x27;40px 40px&#x27;,
        }}
      /&gt;

      &lt;div className=&quot;relative w-full max-w-md&quot;&gt;

        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        &lt;div className=&quot;text-center mb-8&quot;&gt;
          &lt;div className=&quot;inline-flex items-center gap-3 mb-3&quot;&gt;
            &lt;div className=&quot;w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-900/50&quot;&gt;
              &lt;svg className=&quot;w-5 h-5 text-white&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                  d=&quot;M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z&quot; /&gt;
              &lt;/svg&gt;
            &lt;/div&gt;
            &lt;span className=&quot;text-2xl font-bold text-white tracking-tight&quot;&gt;ZeroSend&lt;/span&gt;
          &lt;/div&gt;

          &lt;div className=&quot;inline-flex items-center gap-2 px-3 py-1.5 bg-emerald-950 border border-emerald-800 rounded-full&quot;&gt;
            &lt;span className=&quot;w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse&quot; /&gt;
            &lt;span className=&quot;text-emerald-400 text-xs font-mono font-semibold tracking-wide&quot;&gt;
              ML-KEM-768 / Quantum-Safe
            &lt;/span&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        {/* ç™»éŒ²ã‚«ãƒ¼ãƒ‰ */}
        &lt;div className=&quot;bg-gray-900 border border-gray-800 rounded-2xl p-8 shadow-2xl&quot;&gt;
          &lt;h1 className=&quot;text-lg font-semibold text-white mb-1&quot;&gt;æ–°è¦ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç™»éŒ²&lt;/h1&gt;
          &lt;p className=&quot;text-gray-500 text-xs mb-6&quot;&gt;é‡å­è€æ€§æš—å·éµãƒšã‚¢ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã«ä¿å­˜ã—ã¾ã™&lt;/p&gt;

          {/* éµç”Ÿæˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒŠãƒ¼ */}
          &lt;KeyGenStatusBanner
            status={keyGenStatus}
            fingerprint={keypair?.fingerprint ?? null}
            onRetry={generateKeypair}
          /&gt;

          &lt;form onSubmit={handleSubmit} noValidate className=&quot;mt-5 space-y-4&quot;&gt;

            {/* ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ */}
            &lt;div&gt;
              &lt;label htmlFor=&quot;reg-email&quot; className=&quot;block text-sm font-medium text-gray-300 mb-1.5&quot;&gt;
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
              &lt;/label&gt;
              &lt;input
                id=&quot;reg-email&quot;
                type=&quot;email&quot;
                autoComplete=&quot;email&quot;
                required
                value={email}
                onChange={e =&gt; { setEmail(e.target.value); setError(null) }}
                disabled={isSubmitting}
                placeholder=&quot;you@example.com&quot;
                className=&quot;w-full px-3.5 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm
                  placeholder-gray-500 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50
                  disabled:opacity-50 transition-colors&quot;
              /&gt;
            &lt;/div&gt;

            {/* è¡¨ç¤ºå */}
            &lt;div&gt;
              &lt;label htmlFor=&quot;reg-name&quot; className=&quot;block text-sm font-medium text-gray-300 mb-1.5&quot;&gt;
                è¡¨ç¤ºå
              &lt;/label&gt;
              &lt;input
                id=&quot;reg-name&quot;
                type=&quot;text&quot;
                autoComplete=&quot;name&quot;
                required
                value={displayName}
                onChange={e =&gt; { setDisplayName(e.target.value); setError(null) }}
                disabled={isSubmitting}
                placeholder=&quot;ç”°ä¸­ å¤ªéƒ&quot;
                className=&quot;w-full px-3.5 py-2.5 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm
                  placeholder-gray-500 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50
                  disabled:opacity-50 transition-colors&quot;
              /&gt;
            &lt;/div&gt;

            {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ */}
            &lt;div&gt;
              &lt;label htmlFor=&quot;reg-password&quot; className=&quot;block text-sm font-medium text-gray-300 mb-1.5&quot;&gt;
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
              &lt;/label&gt;
              &lt;div className=&quot;relative&quot;&gt;
                &lt;input
                  id=&quot;reg-password&quot;
                  type={showPassword ? &#x27;text&#x27; : &#x27;password&#x27;}
                  autoComplete=&quot;new-password&quot;
                  required
                  value={password}
                  onChange={e =&gt; { setPassword(e.target.value); setError(null) }}
                  disabled={isSubmitting}
                  placeholder=&quot;â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢&quot;
                  className=&quot;w-full px-3.5 py-2.5 pr-10 bg-gray-800 border border-gray-700 rounded-lg text-white text-sm
                    placeholder-gray-500 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50
                    disabled:opacity-50 transition-colors&quot;
                /&gt;
                &lt;button
                  type=&quot;button&quot;
                  onClick={() =&gt; setShowPassword(v =&gt; !v)}
                  tabIndex={-1}
                  className=&quot;absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 transition-colors&quot;
                  aria-label={showPassword ? &#x27;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’éš ã™&#x27; : &#x27;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º&#x27;}
                &gt;
                  &lt;svg className=&quot;w-4 h-4&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                    &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                      d={showPassword
                        ? &quot;M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21&quot;
                        : &quot;M15 12a3 3 0 11-6 0 3 3 0 016 0zM2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z&quot;
                      }
                    /&gt;
                  &lt;/svg&gt;
                &lt;/button&gt;
              &lt;/div&gt;

              {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒãƒ¼ */}
              {password.length &gt; 0 &amp;&amp; (
                &lt;div className=&quot;mt-2&quot;&gt;
                  &lt;div className=&quot;flex gap-1 mb-1&quot;&gt;
                    {[0, 1, 2, 3].map(i =&gt; (
                      &lt;div
                        key={i}
                        className={`h-1 flex-1 rounded-full transition-colors ${
                          i &lt; passwordStrength.score
                            ? passwordStrength.score &lt;= 1 ? &#x27;bg-red-500&#x27;
                              : passwordStrength.score &lt;= 2 ? &#x27;bg-yellow-500&#x27;
                              : passwordStrength.score &lt;= 3 ? &#x27;bg-blue-500&#x27;
                              : &#x27;bg-emerald-500&#x27;
                            : &#x27;bg-gray-700&#x27;
                        }`}
                      /&gt;
                    ))}
                  &lt;/div&gt;
                  &lt;p className={`text-xs ${
                    passwordStrength.score &lt;= 1 ? &#x27;text-red-400&#x27;
                      : passwordStrength.score &lt;= 2 ? &#x27;text-yellow-400&#x27;
                      : passwordStrength.score &lt;= 3 ? &#x27;text-blue-400&#x27;
                      : &#x27;text-emerald-400&#x27;
                  }`}&gt;
                    {passwordStrength.label}
                  &lt;/p&gt;
                &lt;/div&gt;
              )}
            &lt;/div&gt;

            {/* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª */}
            &lt;div&gt;
              &lt;label htmlFor=&quot;reg-confirm&quot; className=&quot;block text-sm font-medium text-gray-300 mb-1.5&quot;&gt;
                ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
              &lt;/label&gt;
              &lt;input
                id=&quot;reg-confirm&quot;
                type={showPassword ? &#x27;text&#x27; : &#x27;password&#x27;}
                autoComplete=&quot;new-password&quot;
                required
                value={confirmPw}
                onChange={e =&gt; { setConfirmPw(e.target.value); setError(null) }}
                disabled={isSubmitting}
                placeholder=&quot;â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢&quot;
                className={`w-full px-3.5 py-2.5 bg-gray-800 border rounded-lg text-white text-sm
                  placeholder-gray-500 outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50
                  disabled:opacity-50 transition-colors ${
                    confirmPw &amp;&amp; confirmPw !== password ? &#x27;border-red-700&#x27; : &#x27;border-gray-700&#x27;
                  }`}
              /&gt;
              {confirmPw &amp;&amp; confirmPw !== password &amp;&amp; (
                &lt;p className=&quot;mt-1 text-xs text-red-400&quot;&gt;ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“&lt;/p&gt;
              )}
            &lt;/div&gt;

            {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */}
            {error &amp;&amp; (
              &lt;div role=&quot;alert&quot; className=&quot;flex items-start gap-2.5 px-3.5 py-2.5 bg-red-950/60 border border-red-800 rounded-lg&quot;&gt;
                &lt;svg className=&quot;w-4 h-4 text-red-400 mt-0.5 shrink-0&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                  &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                    d=&quot;M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z&quot; /&gt;
                &lt;/svg&gt;
                &lt;span className=&quot;text-red-300 text-sm&quot;&gt;{error}&lt;/span&gt;
              &lt;/div&gt;
            )}

            {/* ç™»éŒ²ãƒœã‚¿ãƒ³ */}
            &lt;button
              type=&quot;submit&quot;
              disabled={isSubmitting || keyGenStatus !== &#x27;ready&#x27;}
              className=&quot;
                w-full py-2.5 px-4 bg-indigo-600 hover:bg-indigo-500 disabled:bg-indigo-900
                text-white font-semibold text-sm rounded-lg transition-colors duration-150
                disabled:cursor-not-allowed flex items-center justify-center gap-2
                focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900
              &quot;
            &gt;
              {isSubmitting ? (
                &lt;&gt;
                  &lt;svg className=&quot;w-4 h-4 animate-spin&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot;&gt;
                    &lt;circle className=&quot;opacity-25&quot; cx=&quot;12&quot; cy=&quot;12&quot; r=&quot;10&quot; stroke=&quot;currentColor&quot; strokeWidth=&quot;4&quot; /&gt;
                    &lt;path className=&quot;opacity-75&quot; fill=&quot;currentColor&quot; d=&quot;M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z&quot; /&gt;
                  &lt;/svg&gt;
                  &lt;span&gt;ç™»éŒ²ä¸­...&lt;/span&gt;
                &lt;/&gt;
              ) : &#x27;ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ&#x27;}
            &lt;/button&gt;
          &lt;/form&gt;

          &lt;p className=&quot;mt-5 text-center text-sm text-gray-500&quot;&gt;
            æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã®æ–¹ã¯{&#x27; &#x27;}
            &lt;Link to=&quot;/login&quot; className=&quot;text-indigo-400 hover:text-indigo-300 transition-colors font-medium&quot;&gt;
              ãƒ­ã‚°ã‚¤ãƒ³
            &lt;/Link&gt;
          &lt;/p&gt;
        &lt;/div&gt;

        &lt;p className=&quot;mt-4 text-center text-xs text-gray-600&quot;&gt;
          ç§˜å¯†éµã¯ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ã€‚
        &lt;/p&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}

// â”€â”€â”€ ã‚µãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: éµç”Ÿæˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒŠãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface KeyGenStatusBannerProps {
  status: KeyGenStatus
  fingerprint: string | null
  onRetry: () =&gt; void
}

function KeyGenStatusBanner({ status, fingerprint, onRetry }: KeyGenStatusBannerProps) {
  if (status === &#x27;generating&#x27;) {
    return (
      &lt;div className=&quot;flex items-center gap-3 px-4 py-3 bg-indigo-950/50 border border-indigo-800 rounded-xl&quot;&gt;
        &lt;svg className=&quot;w-4 h-4 text-indigo-400 animate-spin shrink-0&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot;&gt;
          &lt;circle className=&quot;opacity-25&quot; cx=&quot;12&quot; cy=&quot;12&quot; r=&quot;10&quot; stroke=&quot;currentColor&quot; strokeWidth=&quot;4&quot; /&gt;
          &lt;path className=&quot;opacity-75&quot; fill=&quot;currentColor&quot; d=&quot;M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z&quot; /&gt;
        &lt;/svg&gt;
        &lt;div&gt;
          &lt;p className=&quot;text-indigo-300 text-xs font-semibold&quot;&gt;ML-KEM-768 éµãƒšã‚¢ç”Ÿæˆä¸­...&lt;/p&gt;
          &lt;p className=&quot;text-indigo-500 text-xs mt-0.5&quot;&gt;æš—å·å­¦çš„ä¹±æ•° (CSPRNG) ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    )
  }

  if (status === &#x27;ready&#x27; &amp;&amp; fingerprint) {
    return (
      &lt;div className=&quot;px-4 py-3 bg-emerald-950/40 border border-emerald-800 rounded-xl&quot;&gt;
        &lt;div className=&quot;flex items-center gap-2 mb-2&quot;&gt;
          &lt;svg className=&quot;w-3.5 h-3.5 text-emerald-400 shrink-0&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2.5}&gt;
            &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; d=&quot;M5 13l4 4L19 7&quot; /&gt;
          &lt;/svg&gt;
          &lt;span className=&quot;text-emerald-400 text-xs font-semibold&quot;&gt;é‡å­è€æ€§éµãƒšã‚¢ç”Ÿæˆå®Œäº†&lt;/span&gt;
        &lt;/div&gt;
        &lt;div className=&quot;flex items-center gap-2&quot;&gt;
          &lt;span className=&quot;text-gray-500 text-xs&quot;&gt;å…¬é–‹éµãƒ•ã‚£ãƒ³ã‚¬ãƒ¼ãƒ—ãƒªãƒ³ãƒˆ:&lt;/span&gt;
          &lt;code className=&quot;text-emerald-300 text-xs font-mono tracking-wider&quot;&gt;{fingerprint}&lt;/code&gt;
        &lt;/div&gt;
        &lt;p className=&quot;text-gray-600 text-xs mt-1.5&quot;&gt;
          ç§˜å¯†éµã¯ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã® IndexedDB ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™
        &lt;/p&gt;
      &lt;/div&gt;
    )
  }

  if (status === &#x27;error&#x27;) {
    return (
      &lt;div className=&quot;flex items-center justify-between px-4 py-3 bg-red-950/40 border border-red-800 rounded-xl&quot;&gt;
        &lt;div className=&quot;flex items-center gap-2&quot;&gt;
          &lt;svg className=&quot;w-4 h-4 text-red-400 shrink-0&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
            &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
              d=&quot;M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z&quot; /&gt;
          &lt;/svg&gt;
          &lt;span className=&quot;text-red-300 text-xs&quot;&gt;éµç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ&lt;/span&gt;
        &lt;/div&gt;
        &lt;button
          type=&quot;button&quot;
          onClick={onRetry}
          className=&quot;text-xs text-indigo-400 hover:text-indigo-300 transition-colors underline&quot;
        &gt;
          å†ç”Ÿæˆ
        &lt;/button&gt;
      &lt;/div&gt;
    )
  }

  return null
}

// â”€â”€â”€ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦è¨ˆç®— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

interface PasswordStrength {
  score: number   // 0ã€œ4
  label: string
}

function getPasswordStrength(password: string): PasswordStrength {
  if (password.length === 0) return { score: 0, label: &#x27;&#x27; }

  let score = 0
  if (password.length &gt;= 8)  score++
  if (password.length &gt;= 12) score++
  if (/[0-9]/.test(password))            score++
  if (/[!@#$%^&amp;*()_+\-=\[\]{}|;&#x27;:&quot;,.&lt;&gt;?\/\\`~]/.test(password)) score++

  const labels = [&#x27;éå¸¸ã«å¼±ã„&#x27;, &#x27;å¼±ã„&#x27;, &#x27;æ™®é€š&#x27;, &#x27;å¼·ã„&#x27;, &#x27;éå¸¸ã«å¼·ã„&#x27;]
  return { score, label: labels[score] ?? &#x27;éå¸¸ã«å¼·ã„&#x27; }
}
</pre>
<div class="box ok"><div class="bt">âœ… STEP 7 å®Œäº†ç¢ºèª</div><p>src/pages/RegisterPage.tsx ãŒä½œæˆã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 8: TotpModal -->
<h1 class="s" id="step8">STEP 8 â€” src/components/auth/TotpModal.tsx æ–°è¦ä½œæˆ <span class="tag-f">F-14</span></h1>
<div class="step todo">
  <div class="sn"><div class="sl">STEP</div><div class="sv">8</div></div>
  <div class="sb">
    <div class="st">TotpModal.tsx ã‚’æ–°è¦ä½œæˆã™ã‚‹ï¼ˆTOTP 2FA å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰</div>
    <div class="ss">Phase 4 ã® DownloadPage ã‹ã‚‰å†åˆ©ç”¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/components/auth/TotpModal.tsx</span>
    <span class="fc-badge new">ğŸ†• æ–°è¦ä½œæˆ</span>
  </div>
  <div class="fc-body"><p class="fc-desc">6æ¡ OTP å…¥åŠ› UIã€‚1æ¡å…¥åŠ›ã”ã¨ã«è‡ªå‹•ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç§»å‹•ã€‚ãƒšãƒ¼ã‚¹ãƒˆã§6æ¡ä¸€æ‹¬å…¥åŠ› + è‡ªå‹•é€ä¿¡ã€‚<br>å¤±æ•—æ™‚ã®æ®‹ã‚Šè©¦è¡Œå›æ•°è¡¨ç¤ºã€‚423 ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ CRITICAL ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²ã€‚</p></div>
</div>
<div class="clbl">frontend/src/components/auth/TotpModal.tsx â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹</div>
<pre>// =============================================================
// ZeroSend â€” components/auth/TotpModal.tsx
//
// ãƒ‘ã‚¹        : frontend/src/components/auth/TotpModal.tsx
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : F-14 TOTP äºŒè¦ç´ èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼ç”¨ï¼‰
//               6æ¡ OTP å…¥åŠ› UIã€‚å¤±æ•—æ™‚ã‚¨ãƒ©ãƒ¼ãƒ»ãƒ­ãƒƒã‚¯æ®‹å›æ•°è¡¨ç¤ºã€‚
//               Phase 4 (DownloadPage) ã‹ã‚‰ä½¿ç”¨ã™ã‚‹å†åˆ©ç”¨å¯èƒ½ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€‚
//
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ:
//   - èªè¨¼å¤±æ•—æ™‚ã® remaining_attempts ã‚’æ­£ç¢ºã«è¡¨ç¤º
//   - 423 ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’è¦–è¦šçš„ã«æ˜ç¢ºã«è¡¨ç¤ºï¼ˆå†è©¦è¡Œãƒœã‚¿ãƒ³éè¡¨ç¤ºï¼‰
//   - OTP ã¯å…¥åŠ›å€¤ã®ã¿ã‚’ä¿æŒï¼ˆé€ä¿¡å¾Œã™ãã«å‚ç…§ã‚’ç ´æ£„ï¼‰
//   - 6å›å¤±æ•—å‰ã« WARN ãƒ­ã‚°ã€ãƒ­ãƒƒã‚¯æ™‚ã« CRITICAL ãƒ­ã‚°
//   - ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã‚„ Esc ã‚­ãƒ¼ã§ã®é–‰é–ã‚’é˜²æ­¢ï¼ˆèªè¨¼å®Œäº†ã¾ã§ï¼‰
//
// Props:
//   urlToken         string               ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ URLãƒˆãƒ¼ã‚¯ãƒ³
//   recipientEmail   string               å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆæœ¬äººç¢ºèªç”¨ï¼‰
//   onSuccess        (authToken) =&gt; void  èªè¨¼æˆåŠŸæ™‚ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
//   onClose          () =&gt; void           é–‰é–ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆisLocked æ™‚ã®ã¿è¨±å¯ï¼‰
//
// ä½¿ç”¨ç®‡æ‰€:
//   @/pages/DownloadPage  (Phase 4 F-35)
// =============================================================

import {
  useState, useRef, useCallback, useEffect, KeyboardEvent, ClipboardEvent
} from &#x27;react&#x27;
import { verifyTotp, type TotpError } from &#x27;@/services/authService&#x27;
import { logSecurityEvent } from &#x27;@/lib/securityLogger&#x27;

// â”€â”€â”€ OTP å…¥åŠ›æ¡æ•° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OTP_LENGTH = 6

// â”€â”€â”€ Props å‹å®šç¾© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export interface TotpModalProps {
  /** ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ URLãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆ/download/:token ã® token éƒ¨åˆ†ï¼‰ */
  urlToken: string
  /** å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆTOTP verify ã®æœ¬äººç¢ºèªç”¨ï¼‰ */
  recipientEmail: string
  /** èªè¨¼æˆåŠŸæ™‚ã« auth_token ã‚’æ¸¡ã™ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ */
  onSuccess: (authToken: string, expiresIn: number) =&gt; void
  /** é–‰é–ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ­ãƒƒã‚¯çŠ¶æ…‹ãƒ»ã‚¨ãƒ©ãƒ¼æ™‚ã®ã¿æœ‰åŠ¹ï¼‰ */
  onClose: () =&gt; void
}

// â”€â”€â”€ TotpModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export function TotpModal({
  urlToken,
  recipientEmail,
  onSuccess,
  onClose,
}: TotpModalProps) {
  const [digits,           setDigits]           = useState&lt;string[]&gt;(Array(OTP_LENGTH).fill(&#x27;&#x27;))
  const [isSubmitting,     setIsSubmitting]      = useState(false)
  const [error,            setError]             = useState&lt;string | null&gt;(null)
  const [remainingAttempts, setRemainingAttempts] = useState&lt;number | null&gt;(null)
  const [isLocked,         setIsLocked]          = useState(false)

  // å„æ¡ã® input ref
  const inputRefs = useRef&lt;(HTMLInputElement | null)[]&gt;(Array(OTP_LENGTH).fill(null))

  // ãƒã‚¦ãƒ³ãƒˆæ™‚ã«æœ€åˆã®å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  useEffect(() =&gt; {
    inputRefs.current[0]?.focus()
  }, [])

  // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã«ãªã£ãŸã‚‰ CRITICAL ãƒ­ã‚°
  useEffect(() =&gt; {
    if (isLocked) {
      logSecurityEvent(&#x27;TOTP_LOCKED&#x27;, &#x27;CRITICAL&#x27;, undefined, undefined, recipientEmail)
    }
  }, [isLocked, recipientEmail])

  // â”€â”€ OTP é€ä¿¡ â”€â”€
  const submitOtp = useCallback(async (otpDigits: string[]) =&gt; {
    const otp = otpDigits.join(&#x27;&#x27;)
    if (otp.length !== OTP_LENGTH) return

    setIsSubmitting(true)
    setError(null)

    try {
      const result = await verifyTotp(urlToken, recipientEmail, otp)
      onSuccess(result.authToken, result.expiresIn)
    } catch (err) {
      const totpErr = err as TotpError

      if (totpErr.isLocked) {
        setIsLocked(true)
        setError(&#x27;èªè¨¼è©¦è¡Œå›æ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã“ã®URLã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚&#x27;)
      } else {
        setRemainingAttempts(totpErr.remainingAttempts ?? null)
        setError(totpErr.message ?? &#x27;èªè¨¼ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“&#x27;)
        // ã‚¨ãƒ©ãƒ¼æ™‚: å…¨æ¡ã‚¯ãƒªã‚¢ã—ã¦æœ€åˆã®æ¡ã«æˆ»ã™
        setDigits(Array(OTP_LENGTH).fill(&#x27;&#x27;))
        setTimeout(() =&gt; inputRefs.current[0]?.focus(), 50)
      }
    } finally {
      setIsSubmitting(false)
    }
  }, [urlToken, recipientEmail, onSuccess])

  // â”€â”€ å…¥åŠ›å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ© â”€â”€
  const handleChange = useCallback((index: number, value: string) =&gt; {
    // æ•°å­—ã®ã¿è¨±å¯
    const digit = value.replace(/\D/g, &#x27;&#x27;).slice(-1)

    setDigits(prev =&gt; {
      const next = [...prev]
      next[index] = digit
      return next
    })

    setError(null)

    if (digit) {
      // æ¬¡ã®æ¡ã¸ç§»å‹•
      if (index &lt; OTP_LENGTH - 1) {
        inputRefs.current[index + 1]?.focus()
      } else {
        // æœ€å¾Œã®æ¡å…¥åŠ›å®Œäº† â†’ è‡ªå‹•é€ä¿¡
        const newDigits = [...digits]
        newDigits[index] = digit
        submitOtp(newDigits)
      }
    }
  }, [digits, submitOtp])

  // â”€â”€ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒãƒ³ãƒ‰ãƒ© â”€â”€
  const handleKeyDown = useCallback((index: number, e: KeyboardEvent&lt;HTMLInputElement&gt;) =&gt; {
    if (e.key === &#x27;Backspace&#x27;) {
      if (digits[index]) {
        // ç¾åœ¨ã®æ¡ã‚’ã‚¯ãƒªã‚¢
        setDigits(prev =&gt; {
          const next = [...prev]
          next[index] = &#x27;&#x27;
          return next
        })
      } else if (index &gt; 0) {
        // å‰ã®æ¡ã«æˆ»ã‚‹
        inputRefs.current[index - 1]?.focus()
        setDigits(prev =&gt; {
          const next = [...prev]
          next[index - 1] = &#x27;&#x27;
          return next
        })
      }
    } else if (e.key === &#x27;ArrowLeft&#x27; &amp;&amp; index &gt; 0) {
      inputRefs.current[index - 1]?.focus()
    } else if (e.key === &#x27;ArrowRight&#x27; &amp;&amp; index &lt; OTP_LENGTH - 1) {
      inputRefs.current[index + 1]?.focus()
    } else if (e.key === &#x27;Enter&#x27;) {
      submitOtp(digits)
    }
  }, [digits, submitOtp])

  // â”€â”€ ãƒšãƒ¼ã‚¹ãƒˆå¯¾å¿œï¼ˆ6æ¡ä¸€æ‹¬å…¥åŠ›ï¼‰ â”€â”€
  const handlePaste = useCallback((e: ClipboardEvent&lt;HTMLInputElement&gt;) =&gt; {
    e.preventDefault()
    const pasted = e.clipboardData.getData(&#x27;text&#x27;).replace(/\D/g, &#x27;&#x27;).slice(0, OTP_LENGTH)
    if (!pasted) return

    const newDigits = Array(OTP_LENGTH).fill(&#x27;&#x27;)
    pasted.split(&#x27;&#x27;).forEach((char, i) =&gt; {
      newDigits[i] = char
    })
    setDigits(newDigits)
    setError(null)

    // ãƒšãƒ¼ã‚¹ãƒˆã§å…¨æ¡æƒã£ãŸå ´åˆã¯è‡ªå‹•é€ä¿¡
    if (pasted.length === OTP_LENGTH) {
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æœ€å¾Œã®æ¡ã«
      inputRefs.current[OTP_LENGTH - 1]?.focus()
      submitOtp(newDigits)
    } else {
      inputRefs.current[pasted.length]?.focus()
    }
  }, [submitOtp])

  // â”€â”€ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â”€â”€
  return (
    &lt;div
      className=&quot;fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm&quot;
      role=&quot;dialog&quot;
      aria-modal=&quot;true&quot;
      aria-labelledby=&quot;totp-modal-title&quot;
      // ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®ã¿å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‰ã‚Œã‚‹
      onClick={isLocked ? onClose : undefined}
    &gt;
      &lt;div
        className=&quot;relative w-full max-w-sm mx-4 bg-gray-900 border border-gray-800 rounded-2xl p-8 shadow-2xl&quot;
        onClick={e =&gt; e.stopPropagation()}
      &gt;

        {/* ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã®é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ */}
        {isLocked &amp;&amp; (
          &lt;button
            type=&quot;button&quot;
            onClick={onClose}
            className=&quot;absolute top-4 right-4 text-gray-500 hover:text-gray-300 transition-colors&quot;
            aria-label=&quot;é–‰ã˜ã‚‹&quot;
          &gt;
            &lt;svg className=&quot;w-5 h-5&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
              &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot; d=&quot;M6 18L18 6M6 6l12 12&quot; /&gt;
            &lt;/svg&gt;
          &lt;/button&gt;
        )}

        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        &lt;div className=&quot;text-center mb-6&quot;&gt;
          &lt;div className={`w-12 h-12 rounded-xl flex items-center justify-center mx-auto mb-3 ${
            isLocked ? &#x27;bg-red-950 border border-red-800&#x27; : &#x27;bg-indigo-950 border border-indigo-800&#x27;
          }`}&gt;
            {isLocked ? (
              &lt;svg className=&quot;w-6 h-6 text-red-400&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                  d=&quot;M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z&quot; /&gt;
              &lt;/svg&gt;
            ) : (
              &lt;svg className=&quot;w-6 h-6 text-indigo-400&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
                &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                  d=&quot;M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 8.25h3m-3 3h3m-3 3h3&quot; /&gt;
              &lt;/svg&gt;
            )}
          &lt;/div&gt;

          &lt;h2
            id=&quot;totp-modal-title&quot;
            className=&quot;text-lg font-semibold text-white&quot;
          &gt;
            {isLocked ? &#x27;ã‚¢ã‚¯ã‚»ã‚¹ãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ&#x27; : &#x27;2æ®µéšèªè¨¼&#x27;}
          &lt;/h2&gt;

          {!isLocked &amp;&amp; (
            &lt;p className=&quot;text-gray-400 text-sm mt-1&quot;&gt;
              èªè¨¼ã‚¢ãƒ—ãƒªã®6æ¡ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
            &lt;/p&gt;
          )}

          {/* å—ä¿¡è€…ãƒ¡ãƒ¼ãƒ«è¡¨ç¤º */}
          {recipientEmail &amp;&amp; !isLocked &amp;&amp; (
            &lt;p className=&quot;text-indigo-400 text-xs font-mono mt-2 truncate&quot;&gt;
              {recipientEmail}
            &lt;/p&gt;
          )}
        &lt;/div&gt;

        {/* OTP å…¥åŠ›ã‚¨ãƒªã‚¢ */}
        {!isLocked &amp;&amp; (
          &lt;div
            className=&quot;flex justify-center gap-2.5 mb-5&quot;
            role=&quot;group&quot;
            aria-label=&quot;6æ¡èªè¨¼ã‚³ãƒ¼ãƒ‰å…¥åŠ›&quot;
          &gt;
            {digits.map((digit, index) =&gt; (
              &lt;input
                key={index}
                ref={el =&gt; { inputRefs.current[index] = el }}
                type=&quot;text&quot;
                inputMode=&quot;numeric&quot;
                pattern=&quot;[0-9]*&quot;
                maxLength={1}
                value={digit}
                onChange={e =&gt; handleChange(index, e.target.value)}
                onKeyDown={e =&gt; handleKeyDown(index, e)}
                onPaste={handlePaste}
                onFocus={e =&gt; e.target.select()}
                disabled={isSubmitting || isLocked}
                aria-label={`${index + 1}æ¡ç›®`}
                className={`
                  w-10 h-12 text-center text-lg font-bold font-mono rounded-xl border
                  text-white bg-gray-800 caret-transparent
                  transition-all duration-150 outline-none
                  disabled:opacity-40 disabled:cursor-not-allowed
                  focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500/50
                  ${error &amp;&amp; !isLocked ? &#x27;border-red-700 bg-red-950/20&#x27; : &#x27;border-gray-700&#x27;}
                  ${digit ? &#x27;border-indigo-600/70&#x27; : &#x27;&#x27;}
                `}
              /&gt;
            ))}
          &lt;/div&gt;
        )}

        {/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */}
        {error &amp;&amp; (
          &lt;div
            role=&quot;alert&quot;
            aria-live=&quot;assertive&quot;
            className={`mb-4 px-3.5 py-2.5 rounded-lg text-sm flex items-start gap-2 ${
              isLocked
                ? &#x27;bg-red-950/60 border border-red-800 text-red-300&#x27;
                : &#x27;bg-yellow-950/40 border border-yellow-800 text-yellow-300&#x27;
            }`}
          &gt;
            &lt;svg className=&quot;w-4 h-4 mt-0.5 shrink-0&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot; stroke=&quot;currentColor&quot; strokeWidth={2}&gt;
              &lt;path strokeLinecap=&quot;round&quot; strokeLinejoin=&quot;round&quot;
                d=&quot;M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z&quot; /&gt;
            &lt;/svg&gt;
            &lt;span&gt;{error}&lt;/span&gt;
          &lt;/div&gt;
        )}

        {/* æ®‹ã‚Šè©¦è¡Œå›æ•° */}
        {remainingAttempts !== null &amp;&amp; !isLocked &amp;&amp; (
          &lt;p className=&quot;text-center text-xs text-yellow-500 mb-3&quot;&gt;
            æ®‹ã‚Šè©¦è¡Œå›æ•°: &lt;span className=&quot;font-bold&quot;&gt;{remainingAttempts}&lt;/span&gt;å›
          &lt;/p&gt;
        )}

        {/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */}
        {isSubmitting &amp;&amp; (
          &lt;div className=&quot;flex justify-center items-center gap-2 text-indigo-400 text-sm&quot;&gt;
            &lt;svg className=&quot;w-4 h-4 animate-spin&quot; fill=&quot;none&quot; viewBox=&quot;0 0 24 24&quot;&gt;
              &lt;circle className=&quot;opacity-25&quot; cx=&quot;12&quot; cy=&quot;12&quot; r=&quot;10&quot; stroke=&quot;currentColor&quot; strokeWidth=&quot;4&quot; /&gt;
              &lt;path className=&quot;opacity-75&quot; fill=&quot;currentColor&quot; d=&quot;M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z&quot; /&gt;
            &lt;/svg&gt;
            &lt;span&gt;æ¤œè¨¼ä¸­...&lt;/span&gt;
          &lt;/div&gt;
        )}

        {/* ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ */}
        {!isLocked &amp;&amp; !isSubmitting &amp;&amp; (
          &lt;p className=&quot;text-center text-xs text-gray-600 mt-4&quot;&gt;
            Google Authenticator / Authy ãªã©ã®èªè¨¼ã‚¢ãƒ—ãƒªã‚’ã”åˆ©ç”¨ãã ã•ã„
          &lt;/p&gt;
        )}
      &lt;/div&gt;
    &lt;/div&gt;
  )
}
</pre>
<div class="box ok"><div class="bt">âœ… STEP 8 å®Œäº†ç¢ºèª</div><p>src/components/auth/TotpModal.tsx ãŒä½œæˆã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 9: ProtectedRoute -->
<h1 class="s" id="step9">STEP 9 â€” src/components/layout/ProtectedRoute.tsx ä¸Šæ›¸ãæ›´æ–° <span class="tag-f">F-15</span></h1>
<div class="step sec-step">
  <div class="sn"><div class="sl">STEP</div><div class="sv">9</div></div>
  <div class="sb">
    <div class="st">ğŸ” ProtectedRoute.tsx ã‚’ä¸Šæ›¸ãæ›´æ–°ã™ã‚‹ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¿½åŠ ï¼‰</div>
    <div class="ss">ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œãƒ»æ¨©é™ä¸è¶³ã‚¢ã‚¯ã‚»ã‚¹ã‚’ UNAUTHORIZED / FORBIDDEN ã¨ã—ã¦è¨˜éŒ²ã™ã‚‹</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/components/layout/ProtectedRoute.tsx</span>
    <span class="fc-badge upd sec">ğŸ”„ ä¸Šæ›¸ãæ›´æ–° ğŸ”</span>
  </div>
  <div class="fc-body"><p class="fc-desc">æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹ã‚’ UNAUTHORIZED_ACCESSã€adminæ¨©é™ä¸è¶³ã‚’ FORBIDDEN_ACCESS ã¨ã—ã¦ãƒ­ã‚°è¨˜éŒ²ã€‚ãƒ«ãƒ¼ãƒˆé·ç§»ã”ã¨ã« checkTokenExpiry() ã‚’å®Ÿè¡Œã€‚</p></div>
</div>
<div class="clbl">frontend/src/components/layout/ProtectedRoute.tsx â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆä¸Šæ›¸ãï¼‰</div>
<pre>// =============================================================
// ZeroSend â€” components/layout/ProtectedRoute.tsx
//
// ãƒ‘ã‚¹        : frontend/src/components/layout/ProtectedRoute.tsx
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : F-15 èªè¨¼ã‚¬ãƒ¼ãƒ‰ HOCï¼ˆHigher-Order Componentï¼‰
//               JWT æœªèªè¨¼ â†’ /login ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
//               requireAdmin=true æ™‚ã€admin ãƒ­ãƒ¼ãƒ«ä»¥å¤– â†’ / ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
//               å…¨ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã‚’ securityLogger ã§è¨˜éŒ²
//
// ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ:
//   - æœªèªè¨¼ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œã‚’ã™ã¹ã¦ UNAUTHORIZED_ACCESS ã¨ã—ã¦è¨˜éŒ²
//   - admin æ¨©é™ä¸è¶³ã‚¢ã‚¯ã‚»ã‚¹ã‚’ FORBIDDEN_ACCESS ã¨ã—ã¦è¨˜éŒ²
//   - ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸãƒ‘ã‚¹ã‚’è¨˜éŒ²ï¼ˆç›£æŸ»è¨¼è·¡ï¼‰
//   - Outlet ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‰ã«ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã®ç¢ºèªã‚’å®Ÿæ–½
//
// Props:
//   requireAdmin  boolean  (default: false)  admin ãƒ­ãƒ¼ãƒ«å¿…é ˆãƒ•ãƒ©ã‚°
//
// ä½¿ç”¨ç®‡æ‰€:
//   @/App.tsx  èªè¨¼å¿…é ˆãƒ«ãƒ¼ãƒˆã®ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ã—ã¦ä½¿ç”¨
// =============================================================

import { useEffect } from &#x27;react&#x27;
import { Navigate, Outlet, useLocation } from &#x27;react-router-dom&#x27;
import { useAuthStore } from &#x27;@/stores/authStore&#x27;
import { logUnauthorizedAccess, logForbiddenAccess } from &#x27;@/lib/securityLogger&#x27;

interface ProtectedRouteProps {
  requireAdmin?: boolean
}

export function ProtectedRoute({ requireAdmin = false }: ProtectedRouteProps) {
  const location        = useLocation()
  const isAuthenticated = useAuthStore(s =&gt; s.isAuthenticated)
  const user            = useAuthStore(s =&gt; s.user)
  const checkTokenExpiry = useAuthStore(s =&gt; s.checkTokenExpiry)

  // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å‰ã«ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆæœŸé™åˆ‡ã‚Œãªã‚‰ logout() ãŒå‘¼ã°ã‚Œã‚‹ï¼‰
  useEffect(() =&gt; {
    if (isAuthenticated) {
      checkTokenExpiry()
    }
  }, [isAuthenticated, checkTokenExpiry, location.pathname])

  // â”€â”€ æœªèªè¨¼ãƒã‚§ãƒƒã‚¯ â”€â”€
  if (!isAuthenticated) {
    logUnauthorizedAccess(location.pathname)

    // state ã«ã‚¢ã‚¯ã‚»ã‚¹å…ˆã‚’ä¿å­˜ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å¾Œã«å…ƒã®ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Œã‚‹ã‚ˆã†ï¼‰
    return &lt;Navigate to=&quot;/login&quot; state={{ from: location }} replace /&gt;
  }

  // â”€â”€ Admin æ¨©é™ãƒã‚§ãƒƒã‚¯ â”€â”€
  if (requireAdmin &amp;&amp; user?.role !== &#x27;admin&#x27;) {
    logForbiddenAccess(location.pathname, user?.role ?? &#x27;unknown&#x27;)
    return &lt;Navigate to=&quot;/&quot; replace /&gt;
  }

  return &lt;Outlet /&gt;
}
</pre>
<div class="box ok"><div class="bt">âœ… STEP 9 å®Œäº†ç¢ºèª</div><p>src/components/layout/ProtectedRoute.tsx ãŒæ›´æ–°ã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 10: App.tsx -->
<h1 class="s" id="step10">STEP 10 â€” src/App.tsx ä¸Šæ›¸ãæ›´æ–° <span class="tag-f">F-12</span><span class="tag-f">F-13</span></h1>
<div class="step todo">
  <div class="sn"><div class="sl">STEP</div><div class="sv">10</div></div>
  <div class="sb">
    <div class="st">App.tsx ã‚’ä¸Šæ›¸ãæ›´æ–°ã™ã‚‹ï¼ˆ/register ãƒ«ãƒ¼ãƒˆè¿½åŠ  + useTokenExpiryWatchï¼‰</div>
    <div class="ss">AppShell ã« useTokenExpiryWatch(60_000) ã‚’è¿½åŠ ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ç›£è¦–ã‚’ã‚¢ãƒ—ãƒªå…¨ä½“ã«é©ç”¨ã™ã‚‹</div>
  </div>
</div>
<div class="file-card">
  <div class="fc-head">
    <span class="fc-path">src/App.tsx</span>
    <span class="fc-badge upd">ğŸ”„ ä¸Šæ›¸ãæ›´æ–°</span>
  </div>
  <div class="fc-body"><p class="fc-desc">Phase 1 ã®å¤‰æ›´ç‚¹: /register ãƒ«ãƒ¼ãƒˆè¿½åŠ ï¼ˆF-13ï¼‰ã€AppShell ã« useTokenExpiryWatch ã‚’çµ±åˆï¼ˆF-12ï¼‰ã€‚</p></div>
</div>
<div class="clbl">frontend/src/App.tsx â€” å®Œå…¨ãªãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ï¼ˆä¸Šæ›¸ãï¼‰</div>
<pre>// =============================================================
// ZeroSend â€” App.tsx
//
// ãƒ‘ã‚¹        : frontend/src/App.tsx
// ä½œæˆæ—¥      : 2026-02-23
// æ›´æ–°æ—¥      : 2026-02-23
//
// æ¦‚è¦        : React Router v7 ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®š
//               Routes: /login / /register / / (send) / /list / /download/:token / /admin
//
// Phase 1 å¤‰æ›´ç‚¹:
//   - /register ãƒ«ãƒ¼ãƒˆè¿½åŠ  (F-13)
//   - useTokenExpiryWatch ã‚’ AppShell ã«è¿½åŠ  (F-12)
//     â†’ ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®å…¨ç”»é¢ã§ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã‚’1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
//     â†’ æœŸé™åˆ‡ã‚Œæ™‚ã¯ authStore.logout(&#x27;token_expired&#x27;) ãŒè‡ªå‹•å®Ÿè¡Œ
//
// ä¾å­˜é–¢ä¿‚:
//   react-router-dom               ^7
//   @tanstack/react-query          ^5
//   @tanstack/react-query-devtools ^5
//   @/lib/queryClient
//   @/components/layout/ProtectedRoute
//   @/components/layout/Navbar
//   @/pages/LoginPage              useTokenExpiryWatch ã‚‚ã“ã“ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
//   @/pages/RegisterPage
//   @/pages/SendPage
//   @/pages/ListPage
//   @/pages/DownloadPage
//   @/pages/AdminPage
// =============================================================

import { BrowserRouter, Routes, Route, Navigate } from &#x27;react-router-dom&#x27;
import { QueryClientProvider } from &#x27;@tanstack/react-query&#x27;
import { ReactQueryDevtools } from &#x27;@tanstack/react-query-devtools&#x27;
import { queryClient } from &#x27;@/lib/queryClient&#x27;
import { ProtectedRoute } from &#x27;@/components/layout/ProtectedRoute&#x27;
import { Navbar } from &#x27;@/components/layout/Navbar&#x27;
import { LoginPage, useTokenExpiryWatch } from &#x27;@/pages/LoginPage&#x27;
import { RegisterPage } from &#x27;@/pages/RegisterPage&#x27;
import { SendPage } from &#x27;@/pages/SendPage&#x27;
import { ListPage } from &#x27;@/pages/ListPage&#x27;
import { DownloadPage } from &#x27;@/pages/DownloadPage&#x27;
import { AdminPage } from &#x27;@/pages/AdminPage&#x27;

// â”€â”€â”€ ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ç›£è¦–ã‚’å†…åŒ…ã—ãŸã‚¢ãƒ—ãƒªã‚·ã‚§ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function AppShell() {
  // F-12: ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã®å®šæœŸãƒã‚§ãƒƒã‚¯ï¼ˆ60ç§’ã”ã¨ï¼‰
  // æœŸé™åˆ‡ã‚Œ â†’ authStore.logout(&#x27;token_expired&#x27;) â†’ ProtectedRoute ãŒ /login ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
  useTokenExpiryWatch(60_000)

  return (
    &lt;&gt;
      &lt;Navbar /&gt;
      &lt;main&gt;
        &lt;Routes&gt;
          {/* èªè¨¼ä¸è¦ãƒ«ãƒ¼ãƒˆ */}
          &lt;Route path=&quot;/login&quot;              element={&lt;LoginPage /&gt;} /&gt;
          &lt;Route path=&quot;/register&quot;           element={&lt;RegisterPage /&gt;} /&gt;    {/* F-13 è¿½åŠ  */}
          &lt;Route path=&quot;/download/:token&quot;    element={&lt;DownloadPage /&gt;} /&gt;

          {/* èªè¨¼å¿…é ˆãƒ«ãƒ¼ãƒˆ */}
          &lt;Route element={&lt;ProtectedRoute /&gt;}&gt;
            &lt;Route path=&quot;/&quot;     element={&lt;SendPage /&gt;} /&gt;
            &lt;Route path=&quot;/list&quot; element={&lt;ListPage /&gt;} /&gt;
          &lt;/Route&gt;

          {/* Admin å°‚ç”¨ãƒ«ãƒ¼ãƒˆ */}
          &lt;Route element={&lt;ProtectedRoute requireAdmin /&gt;}&gt;
            &lt;Route path=&quot;/admin&quot; element={&lt;AdminPage /&gt;} /&gt;
          &lt;/Route&gt;

          {/* æœªå®šç¾©ãƒ‘ã‚¹ â†’ ãƒˆãƒƒãƒ—ã¸ */}
          &lt;Route path=&quot;*&quot; element={&lt;Navigate to=&quot;/&quot; replace /&gt;} /&gt;
        &lt;/Routes&gt;
      &lt;/main&gt;
    &lt;/&gt;
  )
}

// â”€â”€â”€ App ãƒ«ãƒ¼ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

export default function App() {
  return (
    &lt;QueryClientProvider client={queryClient}&gt;
      &lt;BrowserRouter&gt;
        &lt;AppShell /&gt;
      &lt;/BrowserRouter&gt;

      {/* TanStack Query DevToolsï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰ */}
      {import.meta.env.DEV &amp;&amp; (
        &lt;ReactQueryDevtools initialIsOpen={false} /&gt;
      )}
    &lt;/QueryClientProvider&gt;
  )
}
</pre>
<div class="box ok"><div class="bt">âœ… STEP 10 å®Œäº†ç¢ºèª</div><p>src/App.tsx ãŒæ›´æ–°ã•ã‚Œã‚Œã° OKã€‚</p></div>

<hr class="pb">

<!-- STEP 11: å‹•ä½œç¢ºèª -->
<h1 class="s" id="step11">STEP 11 â€” å‹•ä½œç¢ºèªãƒ»ãƒ†ã‚¹ãƒˆ</h1>
<div class="step done">
  <div class="sn"><div class="sl">STEP</div><div class="sv">11</div></div>
  <div class="sb">
    <div class="st">å‹ãƒã‚§ãƒƒã‚¯ â†’ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹• â†’ ãƒ–ãƒ©ã‚¦ã‚¶å‹•ä½œç¢ºèªã®é †ã§å®Ÿæ–½ã™ã‚‹</div>
    <div class="ss">ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’å…ˆã«ç¢ºèªã™ã‚‹ã“ã¨</div>
  </div>
</div>

<h2 class="s">11.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç–é€šç¢ºèª</h2>
<div class="clbl">åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ç¢ºèª</div>
<pre>curl -s http://localhost:8000/api/v1/health</pre>
<div class="result"><span class="ok-r">&#123;"status":"ok"&#125;  â† 200 ãŒè¿”ã‚Œã° OK</span>
<span class="err-r">Connection refused â† ã“ã®å ´åˆã¯ cd ~/projects/zerosend &amp;&amp; docker compose up -d</span></div>

<h2 class="s">11.2 TypeScript å‹ãƒã‚§ãƒƒã‚¯</h2>
<div class="clbl">frontend/ ã§å®Ÿè¡Œ</div>
<pre>pnpm type-check</pre>
<div class="result"><span class="ok-r">âœ… æˆåŠŸæ™‚: ã‚¨ãƒ©ãƒ¼ãªã—ï¼ˆä½•ã‚‚è¡¨ç¤ºã•ã‚Œãªã„ï¼‰</span>
<span class="warn-r">âš ï¸ ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼:</span>
Cannot find module '@/lib/securityLogger'   â†’ STEP 3 ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒæœªä½œæˆ
Property 'expiresIn' does not exist         â†’ authStore.ts ãŒ STEP 5 ã®å†…å®¹ã«æ›´æ–°ã•ã‚Œã¦ã„ãªã„
Module '"@noble/post-quantum/ml-kem"'       â†’ pnpm add @noble/post-quantum ã‚’å®Ÿè¡Œ</div>

<h2 class="s">11.3 é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•</h2>
<div class="clbl">frontend/ ã§å®Ÿè¡Œ</div>
<pre>pnpm dev</pre>
<div class="result"><span class="ok-r">  VITE v7.x.x  ready in 300ms
  âœ  Local:   http://localhost:3000/</span></div>

<h2 class="s">11.4 å‹•ä½œç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
<table>
  <tr><th>#</th><th>æ“ä½œ</th><th>æœŸå¾…å‹•ä½œ</th><th>ã‚¿ã‚¹ã‚¯</th></tr>
  <tr><td>1</td><td><code>http://localhost:3000/</code> ã¸ã‚¢ã‚¯ã‚»ã‚¹</td><td>/login ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« ğŸ”´ UNAUTHORIZED_ACCESS ãƒ­ã‚°</td><td>F-15</td></tr>
  <tr><td>2</td><td><code>/admin</code> ã¸ã‚¢ã‚¯ã‚»ã‚¹</td><td>/login ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ</td><td>F-15</td></tr>
  <tr><td>3</td><td><code>/login</code> ç”»é¢è¡¨ç¤º</td><td>ZeroSend ãƒ­ã‚´ãƒ»Quantum-Safe ãƒãƒƒã‚¸ãƒ»ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹</td><td>F-11</td></tr>
  <tr><td>4</td><td><code>/register</code> ã¸ã‚¢ã‚¯ã‚»ã‚¹</td><td>ã€ŒML-KEM-768 éµãƒšã‚¢ç”Ÿæˆä¸­...ã€â†’ã€Œé‡å­è€æ€§éµãƒšã‚¢ç”Ÿæˆå®Œäº†ã€ãƒãƒŠãƒ¼è¡¨ç¤º</td><td>F-13</td></tr>
  <tr><td>5</td><td><code>/register</code> ã§ç™»éŒ²å®Ÿè¡Œ</td><td>ç™»éŒ²å®Œäº†ç”»é¢ â†’ /login ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« ğŸ”µ REGISTER_SUCCESS</td><td>F-13</td></tr>
  <tr><td>6</td><td>ç™»éŒ²ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</td><td>/ ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« ğŸ”µ LOGIN_SUCCESS</td><td>F-11, F-12</td></tr>
  <tr><td>7</td><td>DevTools â†’ Application â†’ IndexedDB</td><td>zerosend-keys DB ã«ç§˜å¯†éµï¼ˆ2400 bytesï¼‰ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹</td><td>F-13</td></tr>
  <tr><td>8</td><td>èª¤ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³</td><td>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« ğŸŸ¡ LOGIN_FAILURE</td><td>F-11</td></tr>
</table>

<hr class="pb">

<!-- STEP 12: ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚° -->
<h1 class="s" id="trouble">STEP 12 â€” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</h1>

<div class="box err">
  <div class="bt">âŒ Cannot find module '@noble/post-quantum/ml-kem'</div>
  <p><code>pnpm add @noble/post-quantum</code> ã‚’å®Ÿè¡Œã—ã¦å†åº¦ <code>pnpm type-check</code>ã€‚</p>
</div>
<div class="box err">
  <div class="bt">âŒ ml_kem768.keygen is not a function</div>
  <p>import ãƒ‘ã‚¹ç¢ºèª: <code>import &#123; ml_kem768 &#125; from '@noble/post-quantum/ml-kem'</code>ï¼ˆ<code>/kyber</code> ã‚„ <code>/ml_kem</code> ã¯èª¤ã‚Šï¼‰</p>
</div>
<div class="box err">
  <div class="bt">âŒ Property 'expiresIn' does not exist on type ... / setAuth ã®å¼•æ•°ã‚¨ãƒ©ãƒ¼</div>
  <p>authStore.ts ãŒ Phase 0 ã®å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¾ã¾ã€‚STEP 5 ã®å†…å®¹ã§å®Œå…¨ã«ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã€‚</p>
</div>
<div class="box err">
  <div class="bt">âŒ POST /api/v1/auth/register â†’ 400 Bad Request</div>
  <p>DevTools Network ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’ç¢ºèªã€‚<code>display_name</code>ãƒ»<code>public_key_b64</code>ãƒ»<code>key_type: "kyber768"</code> ã®3ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒ snake_case ã§é€ä¿¡ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã€‚</p>
</div>
<div class="box err">
  <div class="bt">âŒ IndexedDB ã«ç§˜å¯†éµãŒä¿å­˜ã•ã‚Œãªã„</div>
  <p><code>src/lib/keyStorage.ts</code> ã« <code>storePrivateKey(userId, key)</code> é–¢æ•°ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèª: <code>cat src/lib/keyStorage.ts | grep storePrivateKey</code></p>
</div>
<div class="box warn">
  <div class="bt">âš ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã« UNAUTHORIZED_ACCESS ãŒå‡ºã‚‹ãŒæ­£å¸¸</div>
  <p>æœªãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã§ / ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨å¿…ãšã“ã®ãƒ­ã‚°ãŒå‡ºã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³å¾Œã¯å‡ºãªããªã‚Šã¾ã™ã€‚</p>
</div>

<hr class="pb">

<!-- ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€  -->
<h1 class="s">Phase 1 å®Œäº†å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ </h1>
<div class="tree">
frontend/src/
â”‚
â”œâ”€â”€ <span class="fn">App.tsx</span>                    <span class="cm">â† ğŸ”„ æ›´æ–°: /register è¿½åŠ ãƒ»useTokenExpiryWatch çµ±åˆ</span>
â”œâ”€â”€ <span class="fn">index.css</span>
â”œâ”€â”€ <span class="fn">main.tsx</span>
â”‚
â”œâ”€â”€ <span class="d">types/</span>
â”‚   â””â”€â”€ <span class="fn">api.ts</span>                <span class="cm">â† å¤‰æ›´ãªã—</span>
â”‚
â”œâ”€â”€ <span class="d">lib/</span>
â”‚   â”œâ”€â”€ <span class="fn">apiClient.ts</span>           <span class="cm">â† å¤‰æ›´ãªã—</span>
â”‚   â”œâ”€â”€ <span class="fn">keyStorage.ts</span>          <span class="cm">â† å¤‰æ›´ãªã—ï¼ˆstorePrivateKey ã‚’ RegisterPage ã‹ã‚‰å‘¼ã¶ï¼‰</span>
â”‚   â”œâ”€â”€ <span class="fn">queryClient.ts</span>         <span class="cm">â† å¤‰æ›´ãªã—</span>
â”‚   â””â”€â”€ <span class="new-f">securityLogger.ts</span>      <span class="cm">â† ğŸ†• æ–°è¦ä½œæˆ</span>
â”‚
â”œâ”€â”€ <span class="d">services/</span>                  <span class="cm">â† ğŸ†• æ–°è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</span>
â”‚   â””â”€â”€ <span class="new-f">authService.ts</span>         <span class="cm">â† ğŸ†• æ–°è¦ä½œæˆ</span>
â”‚
â”œâ”€â”€ <span class="d">stores/</span>
â”‚   â”œâ”€â”€ <span class="fn">authStore.ts</span>           <span class="cm">â† ğŸ”„ æ›´æ–°: expiresIn / checkTokenExpiry è¿½åŠ </span>
â”‚   â”œâ”€â”€ <span class="fn">transferStore.ts</span>       <span class="cm">â† å¤‰æ›´ãªã—</span>
â”‚   â””â”€â”€ <span class="fn">keyStore.ts</span>            <span class="cm">â† å¤‰æ›´ãªã—</span>
â”‚
â”œâ”€â”€ <span class="d">components/</span>
â”‚   â”œâ”€â”€ <span class="d">auth/</span>                  <span class="cm">â† ğŸ†• æ–°è¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª</span>
â”‚   â”‚   â””â”€â”€ <span class="new-f">TotpModal.tsx</span>      <span class="cm">â† ğŸ†• æ–°è¦ä½œæˆ</span>
â”‚   â”œâ”€â”€ <span class="d">layout/</span>
â”‚   â”‚   â”œâ”€â”€ <span class="fn">Navbar.tsx</span>          <span class="cm">â† å¤‰æ›´ãªã—</span>
â”‚   â”‚   â””â”€â”€ <span class="fn">ProtectedRoute.tsx</span>  <span class="cm">â† ğŸ”„ æ›´æ–°: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¿½åŠ </span>
â”‚   â””â”€â”€ <span class="d">shared/</span>
â”‚
â””â”€â”€ <span class="d">pages/</span>
    â”œâ”€â”€ <span class="fn">LoginPage.tsx</span>          <span class="cm">â† ğŸ”„ æ›´æ–°: UI å®Ÿè£…ãƒ»useTokenExpiryWatch export</span>
    â”œâ”€â”€ <span class="new-f">RegisterPage.tsx</span>       <span class="cm">â† ğŸ†• æ–°è¦ä½œæˆ: ML-KEM-768 éµç”Ÿæˆãƒ»IndexedDB ä¿å­˜</span>
    â”œâ”€â”€ <span class="fn">SendPage.tsx</span>           <span class="cm">â† å¤‰æ›´ãªã— (Phase 2)</span>
    â”œâ”€â”€ <span class="fn">ListPage.tsx</span>           <span class="cm">â† å¤‰æ›´ãªã— (Phase 3)</span>
    â”œâ”€â”€ <span class="fn">DownloadPage.tsx</span>       <span class="cm">â† å¤‰æ›´ãªã— (Phase 4) â† TotpModal ã‚’ä½¿ã†</span>
    â””â”€â”€ <span class="fn">AdminPage.tsx</span>          <span class="cm">â† å¤‰æ›´ãªã— (Phase 5)</span>
</div>

<div style="background:var(--navy);color:#fff;border-radius:12px;padding:28px 32px;margin-top:40px;text-align:center">
  <div style="font-size:20px;font-weight:800;margin-bottom:8px">Phase 1 èªè¨¼ãƒ»éµç®¡ç† å®Œäº† ğŸ‰</div>
  <div style="font-size:13px;color:#a5b4fc;margin-bottom:6px">æ¬¡ã¯ <strong>Phase 2ï¼šãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡ç”»é¢ (F-16ã€œF-25)</strong> ã«é€²ã‚“ã§ãã ã•ã„</div>
  <div style="font-size:12px;color:#64748B">ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ / ãƒ‰ãƒ©ãƒƒã‚°&amp;ãƒ‰ãƒ­ãƒƒãƒ— / AES-256-GCM æš—å·åŒ– / åˆ†å‰²ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
</div>

</div></body>
</html>